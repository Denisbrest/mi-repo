<!doctype html><html lang="ru"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>DNK</title>
<style>
:root{color-scheme:dark}*{box-sizing:border-box}
body{margin:0;font:14px system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b0f14;color:#e8eef6}
.w{max-width:920px;margin:0 auto;padding:12px}
.c{background:#121824;border:1px solid #1e2a3b;border-radius:14px;padding:12px}
.r{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
input,button,label{border-radius:12px;border:1px solid #243246;background:#0e141f;color:#e8eef6;padding:10px 12px;font:inherit}
input{flex:1;min-width:200px}button{cursor:pointer}button:disabled{opacity:.55;cursor:not-allowed}
.badge{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid #243246;background:#0e141f}
.dot{width:10px;height:10px;border-radius:50%;background:#555}.ok{background:#22c55e}.w1{background:#f59e0b}.bad{background:#ef4444}
.m{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
.grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
@media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
video{width:100%;background:#000;border-radius:14px;border:1px solid #1e2a3b;aspect-ratio:16/9;object-fit:cover}
small{opacity:.78}#log{margin-top:8px;white-space:pre-wrap;word-break:break-word;max-height:120px;overflow:auto}
</style></head><body><div class="w"><div class="c">
  <div class="r" style="justify-content:space-between">
    <div class="badge"><span id="dot" class="dot w1"></span><b id="st">init‚Ä¶</b></div>
    <small class="m">PeerJS 1.5.2 ‚Ä¢ relay-only</small>
  </div>

  <div style="height:10px"></div>

  <div class="r">
    <button id="btnMedia">üé• –ö–∞–º–µ—Ä–∞</button>
    <button id="btnNew" disabled>üÜï –ù–æ–≤—ã–π —Å–µ–∞–Ω—Å</button>
    <button id="btnIce" disabled>üßä ICE</button>

    <label style="display:flex;gap:8px;align-items:center;padding:10px 12px">
      <input id="tcpOnly" type="checkbox" style="width:18px;height:18px;margin:0"> TCP-only (VPN)
    </label>

    <label style="display:flex;gap:8px;align-items:center;padding:10px 12px">
      <input id="fresh" type="checkbox" checked style="width:18px;height:18px;margin:0"> Fresh session
    </label>
  </div>

  <div style="height:10px"></div>

  <div class="r">
    <button id="btnCopy" disabled>üìã Copy ID</button>
    <span class="m" id="myId">‚Äî</span>
  </div>

  <div style="height:10px"></div>

  <div class="r">
    <input id="peerId" placeholder="ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞">
    <button id="btnCall" disabled>üìû</button>
    <button id="btnHang" disabled>‚õî</button>
  </div>

  <div class="grid">
    <div><small>–õ–æ–∫–∞–ª—å–Ω–æ</small><video id="vLocal" playsinline muted></video></div>
    <div><small>–£–¥–∞–ª—ë–Ω–Ω–æ</small><video id="vRemote" playsinline></video></div>
  </div>

  <div id="log" class="m"></div>
</div></div>

<script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
(()=>{const $=id=>document.getElementById(id);
const log=(s)=>{const el=$("log"); el.textContent=(el.textContent+"\n"+s).slice(-2200); el.scrollTop=1e9;};
const st=(msg,cls)=>{$("st").textContent=msg; $("dot").className="dot "+(cls||"w1"); log(msg);};
const safePlay=v=>{const p=v.play(); if(p&&p.catch)p.catch(()=>{});};

const TURN_USER="YOUR_USERNAME";   // <-- Metered username
const TURN_PASS="YOUR_CREDENTIAL"; // <-- Metered credential

const ICE_BASE=[
 {urls:"stun:stun.relay.metered.ca:80"},
 {urls:"turn:standard.relay.metered.ca:80",username:TURN_USER,credential:TURN_PASS},
 {urls:"turn:standard.relay.metered.ca:443",username:TURN_USER,credential:TURN_PASS},
 {urls:"turns:standard.relay.metered.ca:443?transport=tcp",username:TURN_USER,credential:TURN_PASS}
];
const ICE_TCP=[{urls:"turns:standard.relay.metered.ca:443?transport=tcp",username:TURN_USER,credential:TURN_PASS}];

let peer=null, localStream=null, call=null, streamT=null;
const vL=$("vLocal"), vR=$("vRemote");

function cfg(){return {iceTransportPolicy:"relay",iceServers: $("tcpOnly").checked?ICE_TCP:ICE_BASE};}

async function media(){
 if(localStream) return localStream;
 st("–ó–∞–ø—Ä–æ—Å –∫–∞–º–µ—Ä—ã/–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞‚Ä¶","w1");
 localStream=await navigator.mediaDevices.getUserMedia({
  audio:{echoCancellation:true,noiseSuppression:true,autoGainControl:true},
  video:{facingMode:"user",width:{ideal:640},height:{ideal:360},frameRate:{ideal:24,max:30}}
 });
 vL.srcObject=localStream; safePlay(vL);
 st("–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞","ok");
 return localStream;
}

function clearCall(){
 clearTimeout(streamT);
 if(call){ try{call.close()}catch(e){} }
 call=null; vR.srcObject=null;
 $("btnHang").disabled=true; $("btnIce").disabled=true;
}

function destroyPeer(){
 clearCall();
 if(peer){ try{peer.destroy()}catch(e){} }
 peer=null;
 $("myId").textContent="‚Äî";
 $("btnCopy").disabled=true;
 $("btnCall").disabled=true;
 $("btnNew").disabled=true;
}

function initPeer(){
 if(peer) return;
 if(!window.Peer){ st("PeerJS –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è (CDN)","bad"); return; }
 st("Peer connecting‚Ä¶","w1");
 peer=new Peer(undefined,{debug:1,config:cfg()});

 peer.on("open",id=>{
  $("myId").textContent=id;
  $("btnCopy").disabled=false;
  $("btnNew").disabled=false;
  $("btnCall").disabled=!($("peerId").value.trim()&&localStream);
  st("–ì–æ—Ç–æ–≤ (ID –ø–æ–ª—É—á–µ–Ω)","ok");
 });

 peer.on("call", async c=>{
  await media();
  clearCall();
  call=c; bindCall(call);
  st("–í—Ö–æ–¥—è—â–∏–π‚Ä¶","w1");
  call.answer(localStream);
  $("btnHang").disabled=false; $("btnIce").disabled=false;
 });

 // –í–∞–∂–Ω–æ: –µ—Å–ª–∏ —Å–∏–≥–Ω–∞–ª–∫–∞ —É–ø–∞–ª–∞ ‚Äî –Ω–µ –æ—Å—Ç–∞–≤–ª—è–µ–º ‚Äú–º–µ—Ä—Ç–≤–æ–≥–æ‚Äù peer
 peer.on("disconnected",()=>{ st("Peer disconnected ‚Üí –Ω–æ–≤—ã–π —Å–µ–∞–Ω—Å","bad"); if($("fresh").checked) newSession(); else try{peer.reconnect()}catch(e){} });
 peer.on("close",()=>st("Peer closed","bad"));
 peer.on("error",e=>st("Peer error: "+(e&&e.type?e.type:e),"bad"));
}

function bindCall(c){
 clearTimeout(streamT);
 c.on("stream",s=>{
  vR.srcObject=s; safePlay(vR);
  st("–°–æ–µ–¥–∏–Ω–µ–Ω–æ (relay)","ok");
 });
 c.on("close",()=>end("–ó–∞–≤–µ—Ä—à–µ–Ω–æ"));
 c.on("error",e=>end("Call error: "+(e&&e.type?e.type:e),true));

 // –ï—Å–ª–∏ –Ω–µ—Ç remote stream ‚Äî 1 –ø–æ–ø—ã—Ç–∫–∞ ICE restart
 streamT=setTimeout(()=>{ if(call===c && !vR.srcObject){ st("–ù–µ—Ç –≤–∏–¥–µ–æ ‚Üí ICE restart","w1"); iceRestart(); } },12000);
}

function end(msg,bad){
 clearCall();
 st(msg,bad?"bad":"w1");
}

function iceRestart(){
 if(!call){ st("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞","w1"); return; }
 try{
  const pc=call.peerConnection;
  if(pc && pc.restartIce){ pc.restartIce(); st("ICE restart –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω","w1"); }
  else st("ICE restart –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω","w1");
 }catch(e){ st("ICE restart –æ—à–∏–±–∫–∞","bad"); }
}

function newSession(){
 if(!localStream){ st("–°–Ω–∞—á–∞–ª–∞ –≤–∫–ª—é—á–∏ –∫–∞–º–µ—Ä—É","w1"); return; }
 st("–ù–æ–≤—ã–π —Å–µ–∞–Ω—Å‚Ä¶","w1");
 destroyPeer();
 initPeer();
}

$("btnMedia").onclick=async()=>{
 try{ await media(); newSession(); }
 catch(e){ st("Media error: "+(e&&e.name?e.name:"unknown"),"bad"); }
};

$("btnNew").onclick=newSession;
$("btnIce").onclick=iceRestart;

$("btnCopy").onclick=async()=>{
 const id=$("myId").textContent.trim(); if(!id||id==="‚Äî") return;
 try{ await navigator.clipboard.writeText(id); st("ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω","ok"); }
 catch(e){ st("Clipboard blocked","w1"); }
};

$("peerId").oninput=()=>{ $("btnCall").disabled=!($("peerId").value.trim()&&peer&&localStream); };

$("btnCall").onclick=async()=>{
 const t=$("peerId").value.trim(); if(!t) return;
 await media(); initPeer();
 if(!peer||peer.disconnected){ st("Peer –Ω–µ –≥–æ—Ç–æ–≤","bad"); return; }
 clearCall();
 st("–ó–≤–æ–Ω–∏–º‚Ä¶","w1");
 call=peer.call(t,localStream);
 if(!call){ st("Call –Ω–µ —Å–æ–∑–¥–∞–Ω","bad"); return; }
 bindCall(call);
 $("btnHang").disabled=false; $("btnIce").disabled=false;
};

$("btnHang").onclick=()=>end("–°–±—Ä–æ—à–µ–Ω–æ");

$("tcpOnly").onchange=()=>st("–†–µ–∂–∏–º ICE —Å–º–µ–Ω–∏–ª—Å—è ‚Üí –Ω–∞–∂–º–∏ üÜï –ù–æ–≤—ã–π —Å–µ–∞–Ω—Å","w1");

// –ö–õ–Æ–ß: –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–µ–ª–∞–µ–º –Ω–æ–≤—ã–π —Å–µ–∞–Ω—Å (–µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω Fresh session)
document.addEventListener("visibilitychange",()=>{
 if(document.visibilityState==="visible"){
  st("–í–æ–∑–≤—Ä–∞—Ç –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ","w1");
  if($("fresh").checked) newSession();
  else if(peer && peer.disconnected) try{peer.reconnect()}catch(e){}
 }
});

// –ï—Å–ª–∏ —Å–µ—Ç—å ‚Äú–ø—Ä—ã–≥–Ω—É–ª–∞‚Äù ‚Äî —Ç–æ–∂–µ –Ω–æ–≤—ã–π —Å–µ–∞–Ω—Å (–∏–Ω–∞—á–µ peer –≤–∏—Å–∏—Ç –ø–æ–ª—É–º—ë—Ä—Ç–≤—ã–º)
window.addEventListener("online",()=>{ st("–°–µ—Ç—å online","w1"); if($("fresh").checked) newSession(); });

window.addEventListener("beforeunload",()=>{
 try{ if(localStream) localStream.getTracks().forEach(t=>t.stop()); }catch(e){}
 destroyPeer();
});

st("–ù–∞–∂–º–∏ ¬´–ö–∞–º–µ—Ä–∞¬ª. VPN ‚Üí –≤–∫–ª—é—á–∞–π TCP-only. –í—ã—Ö–æ–¥/–≤–æ–∑–≤—Ä–∞—Ç ‚Üí Fresh session —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—ã–π ID.","w1");
})();
</script></body></html>
