
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Galaxy 4.1 | Premium Link</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        fontFamily: { sans: ['Inter', 'sans-serif'] },
        extend: {
          colors: {
            primary: { DEFAULT: '#0ea5e9', light: '#38bdf8', dark: '#0284c7' },
            surface: '#f8fafc',
            darktext: '#1e293b',
          }
        }
      }
    }
  </script>

  <style>
    body {
      margin: 0; overflow: hidden;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      color: #1e293b;
      font-family: 'Inter', sans-serif;
      touch-action: none;
    }
    #canvas-container { position: absolute; inset: 0; z-index: 0; opacity: 0.5; mix-blend-mode: multiply; }
    .no-scrollbar::-webkit-scrollbar { display: none; }

    video::-webkit-media-controls { display: none !important; }
    video::-webkit-media-controls-start-playback-button { display: none !important; -webkit-appearance: none; }
    video { background-color: transparent; object-fit: cover; outline: none; border: none; }

    .glass-panel {
      background: rgba(255, 255, 255, 0.70);
      backdrop-filter: blur(18px) saturate(180%);
      -webkit-backdrop-filter: blur(18px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.85);
      box-shadow: 0 12px 45px -18px rgba(2,132,199,0.25);
    }

    .sym-btn {
      background: rgba(255, 255, 255, 0.88);
      border: 1px solid rgba(226, 232, 240, 0.95);
      color: #64748b;
      box-shadow: 0 8px 22px -18px rgba(0,0,0,.25);
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    .sym-btn:active {
      background: #0ea5e9;
      color: white;
      border-color: #0ea5e9;
      transform: scale(0.96);
      box-shadow: 0 0 0 4px rgba(14,165,233,0.18), 0 18px 40px -18px rgba(14,165,233,.65);
    }

    #local-v {
      position: absolute;
      width: 104px; height: 146px;
      z-index: 50;
      border-radius: 1rem;
      border: 2px solid rgba(255,255,255,0.95);
      box-shadow: 0 14px 32px rgba(0,0,0,0.12);
      touch-action: none;
      overflow: hidden;
    }

    .input-panel {
      background: rgba(255, 255, 255, 0.82);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border-top: 1px solid rgba(255, 255, 255, 0.9);
      box-shadow: 0 -10px 30px rgba(0,0,0,0.05);
    }

    .modern-input {
      background: rgba(241, 245, 249, 0.85);
      border: 1px solid rgba(203, 213, 225, 0.85);
      color: #334155;
      transition: all 0.2s;
    }
    .modern-input:focus {
      background: white;
      border-color: #0ea5e9;
      box-shadow: 0 0 0 4px rgba(14,165,233,0.12);
      outline: none;
    }

    /* –º–∞–ª–µ–Ω—å–∫–∏–π —Å—Ç–∞—Ç—É—Å —Å–≤–µ—Ä—Ö—É */
    .status-pill{
      position: absolute;
      top: 14px; left: 14px;
      z-index: 60;
      padding: 10px 12px;
      border-radius: 16px;
      display: flex; align-items: center; gap: 10px;
      background: rgba(255,255,255,0.75);
      border: 1px solid rgba(226,232,240,0.9);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 10px 30px -22px rgba(0,0,0,0.22);
    }
    .dot{ width:10px; height:10px; border-radius:999px; background:#94a3b8; }
    .status-text{ font-size:10px; font-weight:800; letter-spacing:.28em; text-transform:uppercase; color:#64748b; }
  </style>
</head>

<body class="h-[100dvh] w-screen flex items-center justify-center overflow-hidden bg-surface">

  <div id="canvas-container"></div>

  <div class="status-pill">
    <div id="dot" class="dot"></div>
    <div id="status" class="status-text">–û–ñ–ò–î–ê–ù–ò–ï</div>
  </div>

  <!-- AUTH -->
  <div id="auth-screen" class="glass-panel z-40 p-8 rounded-[2.5rem] w-full max-w-xs text-center space-y-6 mx-4 transition-all duration-300">
    <div class="w-28 h-28 mx-auto bg-gradient-to-tr from-white to-blue-50 border border-white rounded-3xl flex items-center justify-center shadow-lg shadow-blue-500/10 p-1">
      <div class="w-full h-full bg-white rounded-2xl flex items-center justify-center border border-blue-100">
        <span class="text-5xl font-black text-primary tracking-tighter"
          style="background: linear-gradient(135deg, #0ea5e9, #38bdf8); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">DK</span>
      </div>
    </div>

    <p class="text-[10px] text-slate-400 uppercase font-bold tracking-[0.4em] -mt-3">Premium Connection</p>

    <div id="symbol-pad" class="grid grid-cols-5 gap-3 mt-6"></div>

    <p class="text-[9px] text-slate-500/70 uppercase mt-3 font-medium tracking-widest">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞</p>

    <div class="mt-6 pt-5 border-t border-slate-200/50">
      <p class="text-[10px] text-slate-400 uppercase tracking-widest font-bold flex justify-center items-center">
        –í–∞—à ID:
        <span id="front-id" class="text-primary font-black text-sm ml-2 bg-blue-50 px-3 py-1 rounded-lg shadow-sm">----</span>
        <button id="copy-id" class="ml-2 bg-white border border-slate-200 px-2 py-1 rounded-lg text-xs font-black active:scale-95">‚ßâ</button>
      </p>
    </div>

    <!-- –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ –≥—Ä—É–∑–∏—Ç—Å—è) -->
    <p id="diag" class="text-[10px] text-rose-400 font-bold hidden"></p>
  </div>

  <!-- CHAT UI -->
  <main id="chat-ui" class="absolute inset-0 z-20 flex flex-col hidden bg-slate-50">
    <div id="video-zone" class="absolute inset-0 flex items-center justify-center overflow-hidden rounded-b-[2.5rem]">
      <video id="remote-v" class="w-full h-full hidden object-cover" autoplay playsinline></video>
      <video id="local-v" class="top-4 right-4 transform scale-x-[-1] hidden" autoplay playsinline muted></video>

      <div id="video-wait" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-100/80 text-primary space-y-4 backdrop-blur-md">
        <div class="relative">
          <div class="w-12 h-12 border-4 border-blue-100 rounded-full"></div>
          <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin absolute top-0 left-0"></div>
        </div>
        <p class="text-[10px] font-bold uppercase tracking-[0.3em] text-slate-500 animate-pulse">–ü–æ–∏—Å–∫ —Å–∏–≥–Ω–∞–ª–∞...</p>
      </div>
    </div>

    <footer class="absolute bottom-0 left-0 w-full space-y-3 z-30 pb-6 pt-4 px-4">
      <div id="msgs" class="max-h-40 overflow-y-auto no-scrollbar space-y-2 mb-4 px-2"></div>

      <div id="setup-controls" class="flex flex-col gap-3 glass-panel p-4 rounded-3xl shadow-sm">
        <div class="flex justify-between items-center px-2">
          <span class="text-[9px] text-slate-400 uppercase font-bold">
            –í–∞—à ID: <span id="display-id" class="text-primary font-black text-xs ml-1">----</span>
          </span>
          <button onclick="location.reload()" class="text-[9px] text-rose-400 font-bold uppercase hover:text-rose-600 transition py-1 px-2 bg-rose-50 rounded-lg">–°–±—Ä–æ—Å</button>
        </div>
        <div class="flex gap-3">
          <input type="text" id="target-id" placeholder="ID –Ω–∞–ø–∞—Ä–Ω–∏–∫–∞"
            class="flex-1 modern-input rounded-2xl px-4 py-3 text-sm font-bold outline-none uppercase tracking-widest text-center">
          <button id="connect-btn"
            class="bg-gradient-to-r from-primary to-primary-light text-white px-6 py-3 rounded-2xl text-xs font-black uppercase shadow-lg shadow-blue-500/25 active:scale-95 transition-all">
            –°–í–Ø–ó–¨
          </button>
        </div>
        <p class="text-[10px] text-slate-500 px-2">
          –í–∞–∂–Ω–æ: –æ–±–∞ –¥–æ–ª–∂–Ω—ã –≤—ã–±—Ä–∞—Ç—å <b>–æ–¥–∏–Ω–∞–∫–æ–≤—ã–π</b> –∫–ª—é—á (üëΩ/üöÄ/‚Ä¶)
        </p>
      </div>

      <div id="chat-controls" class="flex gap-3 hidden input-panel p-4 rounded-[2rem] transition-all duration-300 items-center shadow-[0_-10px_40px_rgba(0,0,0,0.05)]">
        <button id="call-btn" class="bg-white text-primary p-3 rounded-2xl text-xl shadow-md border border-blue-100 active:scale-95 transition-all active:bg-blue-50">üìπ</button>
        <input type="text" id="msg-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." class="flex-1 modern-input rounded-2xl px-5 py-3 text-sm outline-none h-full font-medium">
        <button id="send-btn" class="bg-gradient-to-tr from-indigo-500 to-purple-500 text-white px-6 py-3 rounded-2xl font-bold active:scale-95 transition-all shadow-lg shadow-indigo-500/25 h-full text-lg">‚û§</button>
      </div>
    </footer>
  </main>

  <script>
    /* ---------- —Å—Ç–∞—Ç—É—Å ---------- */
    function setStatus(text, color) {
      document.getElementById('status').textContent = text;
      document.getElementById('dot').style.background = color || '#94a3b8';
    }

    /* ---------- –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫ (—á—Ç–æ–±—ã —Å—Ä–∞–∑—É –≤–∏–¥–µ—Ç—å, —á—Ç–æ –Ω–µ –≥—Ä—É–∑–∏—Ç—Å—è) ---------- */
    function diagFail(msg) {
      const d = document.getElementById('diag');
      d.textContent = msg;
      d.classList.remove('hidden');
      setStatus('–û–®–ò–ë–ö–ê', '#ef4444');
    }

    if (!window.THREE) diagFail('THREE.js –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è (–ø—Ä–æ–≤–µ—Ä—å –¥–æ—Å—Ç—É–ø –∫ cdnjs).');
    if (!window.Peer) diagFail('PeerJS –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è (–ø—Ä–æ–≤–µ—Ä—å –¥–æ—Å—Ç—É–ø –∫ unpkg).');

    /* ---------- —Ñ–æ–Ω ---------- */
    try {
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
      camera.position.z = 5;

      const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setClearColor(0x000000, 0);
      document.getElementById('canvas-container').appendChild(renderer.domElement);

      const starGeo = new THREE.BufferGeometry();
      const starPos = new Float32Array(9000 * 3);
      for (let i = 0; i < starPos.length; i++) starPos[i] = (Math.random() - 0.5) * 15;
      starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
      const stars = new THREE.Points(
        starGeo,
        new THREE.PointsMaterial({ size: 0.02, color: 0x94a3b8, transparent: true, opacity: 0.22 })
      );
      scene.add(stars);

      function animate() {
        stars.rotation.y += 0.00012;
        renderer.render(scene, camera);
        requestAnimationFrame(animate);
      }
      animate();

      window.addEventListener('resize', () => {
        renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
        renderer.setSize(window.innerWidth, window.innerHeight);
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
      });
    } catch (e) {
      // –µ—Å–ª–∏ three —É–ø–∞–ª ‚Äî –ø—Ä–æ—Å—Ç–æ –º–æ–ª—á–∞, –Ω–æ —Å—Ç–∞—Ç—É—Å –ø–æ–∫–∞–∂–µ–º
      setStatus('–§–û–ù OFF', '#f59e0b');
    }

    /* ---------- drag local video ---------- */
    const localV = document.getElementById('local-v');
    let isDragging = false, startX = 0, startY = 0;

    localV.addEventListener('touchstart', (e) => {
      isDragging = true;
      startX = e.touches[0].clientX - localV.offsetLeft;
      startY = e.touches[0].clientY - localV.offsetTop;
      localV.style.borderColor = "#38bdf8";
    }, { passive: true });

    document.addEventListener('touchmove', (e) => {
      if (!isDragging) return;
      const x = Math.max(0, Math.min(e.touches[0].clientX - startX, window.innerWidth - localV.offsetWidth));
      const y = Math.max(0, Math.min(e.touches[0].clientY - startY, window.innerHeight - localV.offsetHeight));
      localV.style.left = x + 'px';
      localV.style.top = y + 'px';
      localV.style.right = 'auto';
      localV.style.bottom = 'auto';
    }, { passive: true });

    document.addEventListener('touchend', () => {
      isDragging = false;
      localV.style.borderColor = "white";
    });

    /* ---------- —Ç–≤–æ—ë —è–¥—Ä–æ —Å–µ—Ç–∏ (–ø–æ—á—Ç–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---------- */
    let roomPass = "";
    let peer = null;
    let conn = null;
    let localStream = null;

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –ø–∞–º—è—Ç—å ID
    let myStaticId = localStorage.getItem('myGalaxyId');
    if (!myStaticId) {
      myStaticId = Math.random().toString(36).substring(2, 6).toUpperCase();
      localStorage.setItem('myGalaxyId', myStaticId);
    }

    function copyId() {
      const txt = myStaticId;
      if (navigator.clipboard?.writeText) navigator.clipboard.writeText(txt);
      setStatus('–°–ö–û–ü–ò–†–û–í–ê–ù–û', '#22c55e');
      setTimeout(() => setStatus('–û–ñ–ò–î–ê–ù–ò–ï', '#94a3b8'), 900);
    }

    document.getElementById('copy-id').onclick = copyId;

    window.addEventListener('load', () => {
      document.getElementById('front-id').textContent = myStaticId;
      document.getElementById('display-id').textContent = myStaticId;
      if (localStorage.getItem('lastTarget')) {
        document.getElementById('target-id').value = localStorage.getItem('lastTarget');
      }
      setStatus('–û–ñ–ò–î–ê–ù–ò–ï', '#94a3b8');
    });

    const sysCode = [
      { i: 'üëΩ', v: 'alien' }, { i: 'üöÄ', v: 'rocket' }, { i: 'üõ∞Ô∏è', v: 'sat' }, { i: 'üõ∏', v: 'ufo' }, { i: 'üåç', v: 'earth' },
      { i: 'üåô', v: 'moon' }, { i: 'ü™ê', v: 'planet' }, { i: '‚òÑÔ∏è', v: 'comet' }, { i: 'ü§ñ', v: 'bot' }, { i: '‚ò¢Ô∏è', v: 'nuke' }
    ];

    const pad = document.getElementById('symbol-pad');
    sysCode.forEach(s => {
      const btn = document.createElement('button');
      btn.className = 'sym-btn rounded-2xl text-2xl py-4 flex justify-center items-center';
      btn.textContent = s.i;
      btn.onclick = () => {
        roomPass = s.v;

        const authScreen = document.getElementById('auth-screen');
        authScreen.style.opacity = '0';
        authScreen.style.transform = 'scale(0.95) translateY(20px)';

        setStatus('–ó–ê–ü–£–°–ö...', '#0ea5e9');

        setTimeout(() => {
          authScreen.style.display = 'none';
          document.getElementById('chat-ui').style.display = 'flex';
          initPeer();
        }, 300);
      };
      pad.appendChild(btn);
    });

    function initPeer() {
      if (!window.Peer) { diagFail('PeerJS –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω.'); return; }

      setStatus('–°–ï–¢–¨...', '#0ea5e9');

      peer = new Peer(roomPass + '-' + myStaticId.toLowerCase(), {
        config: {
          iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },

            // —Ç–≤–æ–∏ TURN
            { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' },
            { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' },
            { urls: 'turn:openrelay.metered.ca:443?transport=tcp', username: 'openrelayproject', credential: 'openrelayproject' },

            // –¥–æ–±–∞–≤–∫–∞ –¥–ª—è VPN (TLS)
            { urls: 'turns:openrelay.metered.ca:443?transport=tcp', username: 'openrelayproject', credential: 'openrelayproject' }
          ]
        }
      });

      peer.on('open', () => {
        setStatus('–ì–û–¢–û–í–û', '#22c55e');
        addMsg('–°–µ—Ç—å –∞–∫—Ç–∏–≤–Ω–∞', true);
      });

      peer.on('error', (e) => {
        setStatus('–û–®–ò–ë–ö–ê', '#ef4444');
        addMsg('Peer error: ' + (e?.type || 'unknown'), true);
      });

      peer.on('connection', c => { conn = c; bindEvents(); });

      peer.on('call', async call => {
        if (confirm('–í—Ö–æ–¥—è—â–∏–π –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫. –ü—Ä–∏–Ω—è—Ç—å?')) {
          try {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            localV.srcObject = localStream;
            localV.classList.remove('hidden');

            call.answer(localStream);
            call.on('stream', s => {
              const remoteV = document.getElementById('remote-v');
              remoteV.srcObject = s;
              remoteV.classList.remove('hidden');
              document.getElementById('video-wait').style.display = 'none';
              setStatus('–í–ò–î–ï–û', '#22c55e');
            });

            call.on('close', () => {
              document.getElementById('remote-v').srcObject = null;
              document.getElementById('remote-v').classList.add('hidden');
              document.getElementById('video-wait').style.display = 'flex';
              addMsg('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω', true);
              setStatus('–ù–ê –°–í–Ø–ó–ò', '#22c55e');
            });
          } catch (e) {
            alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ!");
            setStatus('–ö–ê–ú–ï–†–ê?', '#f59e0b');
          }
        }
      });
    }

    document.getElementById('connect-btn').onclick = () => {
      const tid = document.getElementById('target-id').value.trim().toUpperCase();
      if (!tid) return;

      localStorage.setItem('lastTarget', tid);

      if (!peer) { addMsg('–°–µ—Ç—å –Ω–µ –≥–æ—Ç–æ–≤–∞', true); setStatus('–°–ï–¢–¨?', '#f59e0b'); return; }

      setStatus('–ö–û–ù–ù–ï–ö–¢...', '#0ea5e9');
      conn = peer.connect(roomPass + '-' + tid.toLowerCase());
      bindEvents();
    };

    function bindEvents() {
      if (!conn) return;

      conn.on('open', () => {
        addMsg('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', true);
        document.getElementById('setup-controls').style.display = 'none';
        document.getElementById('chat-controls').classList.remove('hidden');
        setStatus('–ù–ê –°–í–Ø–ó–ò', '#22c55e');
      });

      conn.on('data', d => addMsg(d, false));

      conn.on('close', () => {
        addMsg('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ', true);
        setStatus('–†–ê–ó–†–´–í', '#f59e0b');
      });
    }

    function addMsg(text, isSys) {
      const msgs = document.getElementById('msgs');
      const d = document.createElement('div');

      if (isSys) {
        d.className = 'text-center text-[9px] text-slate-400 font-bold uppercase tracking-wider py-2';
        d.textContent = text;
      } else {
        // –±–µ–∑–æ–ø–∞—Å–Ω–æ: –±–µ–∑ innerHTML –¥–ª—è —Ç–µ–∫—Å—Ç–∞
        const isMine = String(text).startsWith('me:');
        const clean = isMine ? String(text).replace('me:', '') : String(text);

        d.className = `flex ${isMine ? 'justify-end' : 'justify-start'}`;

        const bubble = document.createElement('div');
        bubble.className = `${isMine ? 'bg-gradient-to-br from-primary to-primary-light text-white shadow-blue-500/20'
          : 'bg-white text-darktext border border-slate-100 shadow-slate-200/50'} px-4 py-3 rounded-2xl text-sm max-w-[85%] shadow-md font-medium leading-tight`;
        bubble.textContent = clean;

        d.appendChild(bubble);
      }

      msgs.appendChild(d);
      msgs.scrollTop = msgs.scrollHeight;
    }

    document.getElementById('send-btn').onclick = (e) => {
      e.preventDefault();
      const v = document.getElementById('msg-in').value.trim();
      if (v && conn && conn.open) {
        conn.send(v);
        addMsg('me:' + v, false);
        document.getElementById('msg-in').value = '';
      } else {
        addMsg('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', true);
        setStatus('–ù–ï–¢ –°–í–Ø–ó–ò', '#f59e0b');
      }
    };

    document.getElementById('call-btn').onclick = async () => {
      if (!conn || !conn.open) { addMsg('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Å—å', true); setStatus('–ù–ï–¢ –°–í–Ø–ó–ò', '#f59e0b'); return; }

      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
