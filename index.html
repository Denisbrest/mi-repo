<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Омега 3.0 | VIP</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

  <script defer src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

  <style>
    :root{
      --p:#0ea5e9; --p2:#38bdf8; --bg1:#f0f9ff; --bg2:#e0f2fe;
      --t:#0f172a; --m:#64748b; --glass: rgba(255,255,255,.85);
      --st: rgba(226,232,240,.92);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; margin:0; overflow:hidden; touch-action:none; }
    body{
      font-family: Inter, sans-serif;
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      color:var(--t);
    }
    .bg{
      position:fixed; inset:0; pointer-events:none; opacity:.4;
      background-image: radial-gradient(rgba(148,163,184,.25) 1px, transparent 1px);
      background-size: 18px 18px;
    }
    .status{
      position:fixed; top:14px; left:14px; z-index:50;
      display:flex; align-items:center; gap:10px;
      padding:10px 14px; border-radius:16px;
      background: var(--glass); border:1px solid var(--st);
      box-shadow: 0 4px 15px rgba(0,0,0,.05);
    }
    .dot{ width:10px; height:10px; border-radius:999px; background:#94a3b8; transition:background .3s; }
    .stxt{ font-size:10px; font-weight:900; letter-spacing:.26em; text-transform:uppercase; color:var(--m); }

    .wrap{ position:relative; z-index:10; width:100%; height:100%; display:flex; align-items:center; justify-content:center; padding:16px; }
    .card{
      width:min(390px, 92vw); border-radius: 34px;
      background: var(--glass); border:1px solid var(--st);
      box-shadow: 0 10px 40px rgba(2,132,199,.12);
      padding: 28px; text-align:center;
    }
    .logoWrap{
      width:110px; height:110px; margin:0 auto 10px; border-radius: 30px; padding:6px;
      background: linear-gradient(135deg, #fff, rgba(56,189,248,.15));
      border:1px solid rgba(255,255,255,.8);
    }
    .logo{
      width:100%; height:100%; border-radius: 24px;
      display:flex; align-items:center; justify-content:center;
      background: #fff; border:1px solid rgba(56,189,248,.2);
      font-weight:900; font-size:46px; letter-spacing: -2px;
      background: linear-gradient(135deg, var(--p), var(--p2));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }
    .cap{ font-size:10px; letter-spacing:.42em; text-transform:uppercase; font-weight:900; color:var(--m); }
    .sub{ margin-top:8px; font-size:12px; font-weight:800; color:#64748b; text-transform:uppercase; letter-spacing:.15em; }

    .pad{ display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; margin-top:20px; }
    .btn{
      height:50px; border-radius:16px; font-size:14px; font-weight:900; letter-spacing: .1em;
      background: #fff; border:1px solid #e2e8f0; color:var(--p);
      box-shadow: 0 4px 10px rgba(0,0,0,.03); transition: transform .1s, background .1s, color .1s;
    }
    .btn:active{ transform: scale(.95); background: var(--p); color:#fff; border-color: var(--p); }

    .row{
      margin-top:20px; padding-top:16px; border-top:1px solid #e2e8f0;
      display:flex; align-items:center; justify-content:center; gap:10px;
      font-size:11px; font-weight:900; letter-spacing:.28em; color:var(--m);
    }
    .chip{ padding:8px 16px; min-width:88px; border-radius:14px; background: rgba(14,165,233,.10); color: var(--p); font-weight:900; letter-spacing:.18em; }
    .copy{ width:46px; height:40px; border-radius:14px; background: #fff; border:1px solid #e2e8f0; font-weight:900; display:flex; align-items:center; justify-content:center; }
    .hint{ margin-top:12px; font-size:11px; font-weight:800; color:#64748b; text-transform:uppercase; letter-spacing:.05em;}
    .hint b{ color: var(--p); }

    /* App */
    #app{ display:none; position:fixed; inset:0; z-index:30; background: #000; }
    #video-zone{ position:absolute; inset:0; overflow:hidden; }
    #remote-v{ width:100%; height:100%; object-fit:cover; display:none; }
    #local-v{
      position:absolute; top:14px; right:14px; width:110px; height:150px; border-radius:18px;
      border:2px solid rgba(255,255,255,.2); box-shadow: 0 8px 25px rgba(0,0,0,.4); transform: scaleX(-1); display:none; object-fit:cover; z-index:40;
    }
    #wait{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column;
      gap:16px; background: rgba(15,23,42,.95); color: var(--p); z-index:20;
    }
    .spin{
      width:50px; height:50px; border-radius:999px;
      border:4px solid rgba(148,163,184,.1); border-top-color: var(--p);
      animation: rot 1s linear infinite;
    }
    @keyframes rot{ to{ transform: rotate(360deg); } }

    #footer{ position:absolute; left:0; right:0; bottom:30px; display:flex; flex-direction:column; align-items:center; z-index:50; padding:0 20px;}
    
    .panel{ background: rgba(255,255,255,.9); border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,.15); padding: 16px; width:100%; max-width:400px; backdrop-filter:blur(10px);}
    .row2{ display:flex; gap:10px; align-items:center; }
    .in{
      flex:1; height:50px; border-radius: 16px; border:1px solid #cbd5e1; background: #f8fafc;
      text-align:center; font-weight:900; letter-spacing:.2em; text-transform:uppercase; outline:none;
    }
    .in:focus{ background:#fff; border-color:var(--p); }
    .cta{
      height:50px; padding:0 24px; border-radius: 16px; border:none; color:#fff;
      font-weight:900; letter-spacing:.15em; background: linear-gradient(90deg, var(--p), var(--p2));
    }
    .tiny{ width:50px; height:50px; border-radius:16px; border:1px solid #e2e8f0; background:#fff; font-size:18px; font-weight:900; color:var(--m);}

    #controls{ display:none; justify-content:center; align-items:center; width:100%; margin-top:10px; }
    
    /* Новые круглые кнопки */
    .circle-btn {
      width: 76px; height: 76px; border-radius: 50%; border: none;
      box-shadow: 0 12px 30px rgba(0,0,0,0.3); outline: none; cursor:pointer;
      transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .circle-btn:active { transform: scale(0.85); }
    .btn-blue { background: #0ea5e9; border: 3px solid rgba(255,255,255,.2);}
    .btn-green { background: #22c55e; border: 3px solid rgba(255,255,255,.2); }

  </style>
</head>

<body>
  <div class="bg"></div>
  <div class="status"><div id="dot" class="dot"></div><div id="status" class="stxt">ОЖИДАНИЕ</div></div>

  <div class="wrap" id="authWrap">
    <div class="card">
      <div class="logoWrap"><div class="logo">Ω3</div></div>
      <div class="cap">ОМЕГА 3.0 | VIP</div>
      <div class="sub">Секретный шлюз</div>
      
      <div class="pad" id="pad"></div>
      
      <div class="row">ID: <span class="chip" id="frontId">----</span><button class="copy" id="copyBtn">⧉</button></div>
      <div class="hint" id="turnHint"><b>TURN:</b> подготовка моста…</div>
      <div class="hint" id="peerHint"><b>УЗЕЛ:</b> ожидание</div>
    </div>
  </div>

  <div id="app">
    <div id="video-zone">
      <video id="remote-v" autoplay playsinline></video>
      <video id="local-v" autoplay playsinline muted></video>
      <div id="wait"><div class="spin"></div><div class="stxt" style="letter-spacing:.3em; color:#fff;">СИНХРОНИЗАЦИЯ...</div></div>
    </div>
    
    <div id="footer">
      <div class="panel" id="setup">
        <div class="row2" style="justify-content:space-between; margin-bottom:12px;">
          <div class="stxt" style="letter-spacing:.2em;">МОЙ ID: <b style="color:var(--p); font-size:12px;" id="myIdTxt">----</b></div>
          <button class="tiny" onclick="location.reload()">↻</button>
        </div>
        <div class="row2">
          <input class="in" id="target" placeholder="ID ЦЕЛИ" maxlength="4" />
          <button class="cta" id="connect">СВЯЗЬ</button>
        </div>
      </div>
      
      <div id="controls">
        <button class="circle-btn btn-blue" id="video"></button>
        <button class="circle-btn btn-green" id="hang" style="display:none;"></button>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const setStatus = (t, c) => { $("status").textContent = t; $("dot").style.background = c || "#94a3b8"; };
  const TURN_HTTP_ENDPOINT = "http://89.124.78.246:8080/get-turn"; 

  let myId = localStorage.getItem("myGalaxyId");
  if (!myId) { myId = Math.random().toString(36).slice(2,6).toUpperCase(); localStorage.setItem("myGalaxyId", myId); }
  $("frontId").textContent = myId; $("myIdTxt").textContent = myId;

  async function copyText(text){
    try { await navigator.clipboard.writeText(text); return true; } 
    catch {
      try{
        const ta = document.createElement("textarea"); ta.value = text; ta.style.position="fixed"; ta.style.opacity="0";
        document.body.appendChild(ta); ta.select(); const ok = document.execCommand("copy"); document.body.removeChild(ta); return ok;
      } catch { return false; }
    }
  }
  
  $("copyBtn").onclick = async () => {
    if (await copyText(myId)) { setStatus("СКОПИРОВАНО", "#22c55e"); setTimeout(()=>setStatus("ОЖИДАНИЕ","#94a3b8"), 900); }
    else setStatus("РУЧНОЕ КОПИРОВАНИЕ", "#f59e0b");
  };

  // Столицы вместо эмодзи
  const keys = [
    {i:'КИЕВ',v:'kyiv'},{i:'РИМ',v:'rome'},
    {i:'ПАРИЖ',v:'paris'},{i:'ТОКИО',v:'tokyo'},
    {i:'БЕРЛИН',v:'berlin'},{i:'ОСЛО',v:'oslo'},
    {i:'СЕУЛ',v:'seoul'},{i:'ВЕНА',v:'vienna'},
    {i:'БАКУ',v:'baku'},{i:'ДОХА',v:'doha'}
  ];
  
  let roomPass = "", peer = null, conn = null, localStream = null;

  function enterApp(){ $("authWrap").style.display = "none"; $("app").style.display = "block"; }

  async function getIceServers(){
    $("turnHint").innerHTML = "<b>TURN:</b> обход блокировки...";
    try {
      const controller = new AbortController(); const timer = setTimeout(() => controller.abort(), 4000);
      const url = "https://corsproxy.io/?" + encodeURIComponent(TURN_HTTP_ENDPOINT + "?t=" + Date.now());
      const res = await fetch(url, { cache: "no-store", signal: controller.signal });
      clearTimeout(timer);
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      if (!Array.isArray(data)) throw new Error("Bad format");
      $("turnHint").innerHTML = "<b>TURN:</b> ключи получены ✅"; return data;
    } catch(e) {
      $("turnHint").innerHTML = "<b>TURN:</b> резерв (STUN) ⚠️";
      return [ { urls: "stun:stun.l.google.com:19302" }, { urls: "stun:standard.relay.metered.ca:80" } ];
    }
  }

    async function initPeer(){
    if (!window.Peer){ $("peerHint").innerHTML = "<b>УЗЕЛ:</b> ошибка загрузки ❌"; setStatus("ОШИБКА", "#ef4444"); return; }
    setStatus("УЗЕЛ…", "#0ea5e9"); $("peerHint").innerHTML = "<b>УЗЕЛ:</b> подключение к облаку…";
    const iceServers = await getIceServers();
    
    try{ peer && peer.destroy && peer.destroy(); }catch(_){}
    
    // Возвращаемся в публичное облако (оно работает по правильному HTTPS)
    peer = new Peer(roomPass + "-" + myId.toLowerCase(), { 
      config: { iceServers }, 
      debug: 0 
    });

    peer.on("open", () => { setStatus("В СЕТИ", "#22c55e"); $("peerHint").innerHTML = "<b>УЗЕЛ:</b> публичный канал ✅"; });
    peer.on("error", () => { setStatus("СБОЙ УЗЛА", "#ef4444"); $("peerHint").innerHTML = "<b>УЗЕЛ:</b> недоступен ❌"; });
    peer.on("connection", (c) => { conn = c; bindConn(); });
    
    peer.on("call", async (call) => {
      try{
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        $("local-v").srcObject = localStream; $("local-v").style.display = "block";
        call.answer(localStream);
        
        call.on("stream", (s) => { 
          $("remote-v").srcObject = s; 
          $("remote-v").style.display = "block"; 
          $("wait").style.display = "none"; 
          
          $("setup").style.display = "none";
          $("controls").style.display = "flex";
          $("video").style.display = "none";
          $("hang").style.display = "block";
          
          setStatus("ШИФРОВАНИЕ", "#22c55e"); 
        });
        call.on("close", closeCallUI);
      }catch(_){ setStatus("ДОСТУП?", "#f59e0b"); }
    });
    }
  

  function bindConn(){
    if (!conn) return;
    conn.on("open", () => {
      $("setup").style.display = "none"; 
      $("controls").style.display = "flex"; 
      setStatus("КАНАЛ ОТКРЫТ", "#0ea5e9");
    });
    conn.on("close", () => { setStatus("ОБРЫВ", "#ef4444"); $("setup").style.display = "block"; $("controls").style.display = "none"; });
  }

  function closeCallUI(){
    $("remote-v").srcObject = null; $("remote-v").style.display = "none"; 
    $("local-v").style.display = "none"; $("wait").style.display = "flex";
    setStatus("КАНАЛ ОТКРЫТ", "#0ea5e9"); 
    
    // Возвращаем синюю кнопку вызова
    $("video").style.display = "block"; 
    $("hang").style.display = "none";
  }

  $("pad").innerHTML = "";
  keys.forEach(k => {
    const b = document.createElement("button"); b.className = "btn"; b.textContent = k.i;
    b.onclick = async () => { roomPass = k.v; enterApp(); await initPeer(); }; $("pad").appendChild(b);
  });

  $("connect").onclick = () => {
    const tid = ($("target").value || "").trim().toUpperCase(); if (!tid) return;
    setStatus("ПОИСК…", "#0ea5e9"); localStorage.setItem("lastTarget", tid);
    conn = peer.connect(roomPass + "-" + tid.toLowerCase()); bindConn();
  };

  const last = localStorage.getItem("lastTarget"); if (last) $("target").value = last;

  // Синий круг - начать вызов
  $("video").onclick = async () => {
    if (!conn || !conn.open) return;
    try { 
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true }); 
      $("local-v").srcObject = localStream; $("local-v").style.display = "block"; 
      const call = peer.call(conn.peer, localStream); 
      
      $("video").style.display = "none"; 
      $("hang").style.display = "block";
      
      call.on("stream", (s) => { 
        $("remote-v").srcObject = s; $("remote-v").style.display = "block"; 
        $("wait").style.display = "none"; setStatus("ШИФРОВАНИЕ", "#22c55e"); 
      });
      call.on("close", closeCallUI);
    } 
    catch (e) { setStatus("ОШИБКА КАМЕРЫ", "#f59e0b"); }
  };

  // Зеленый круг - сбросить
  $("hang").onclick = () => location.reload();

})();
</script>
</body>
</html>
