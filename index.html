
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Galaxy 5.0 | Premium Link</title>

  <meta name="theme-color" content="#0ea5e9" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        fontFamily: { sans: ['Inter', 'sans-serif'] },
        extend: {
          colors: {
            primary: { DEFAULT: '#0ea5e9', light: '#38bdf8', dark: '#0284c7' },
            ink: '#0f172a'
          }
        }
      }
    }
  </script>

  <style>
    :root {
      --bg1:#f0f9ff; --bg2:#e0f2fe;
      --glass: rgba(255,255,255,.68);
      --glass2: rgba(255,255,255,.82);
      --stroke: rgba(255,255,255,.75);
      --shadow: rgba(2,132,199,.14);
      --text: #0f172a;
      --muted:#64748b;
    }
    [data-theme="dark"]{
      --bg1:#0b1220; --bg2:#0a1b2f;
      --glass: rgba(15,23,42,.55);
      --glass2: rgba(15,23,42,.72);
      --stroke: rgba(148,163,184,.18);
      --shadow: rgba(0,0,0,.30);
      --text: #e2e8f0;
      --muted:#94a3b8;
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      overflow: hidden;
      touch-action: none;
      background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      color: var(--text);
      font-family: 'Inter', sans-serif;
    }

    #canvas-container {
      position: absolute; inset: 0; z-index: 0;
      opacity: .55;
      mix-blend-mode: multiply;
      pointer-events: none;
    }
    [data-theme="dark"] #canvas-container { opacity: .35; mix-blend-mode: screen; }

    .no-scrollbar::-webkit-scrollbar { display: none; }

    video::-webkit-media-controls { display: none !important; }
    video::-webkit-media-controls-start-playback-button { display: none !important; -webkit-appearance: none; }
    video { background: transparent; object-fit: cover; outline: none; border: none; }

    .glass {
      background: var(--glass);
      backdrop-filter: blur(18px) saturate(170%);
      -webkit-backdrop-filter: blur(18px) saturate(170%);
      border: 1px solid var(--stroke);
      box-shadow: 0 18px 60px -18px var(--shadow);
    }
    .glass-strong { background: var(--glass2); }

    .sym-btn {
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(226,232,240,.9);
      box-shadow: 0 10px 25px -18px rgba(0,0,0,.25);
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    [data-theme="dark"] .sym-btn{
      background: rgba(15,23,42,.55);
      border-color: rgba(148,163,184,.18);
      box-shadow: 0 12px 30px -18px rgba(0,0,0,.6);
    }
    .sym-btn:active{
      transform: scale(.96);
      box-shadow: 0 0 0 4px rgba(14,165,233,.18), 0 20px 45px -20px rgba(14,165,233,.45);
      border-color: rgba(14,165,233,.8);
    }

    .modern-input {
      background: rgba(241,245,249,.72);
      border: 1px solid rgba(203,213,225,.78);
      color: var(--text);
      transition: box-shadow .18s ease, border-color .18s ease, background .18s ease;
    }
    [data-theme="dark"] .modern-input{
      background: rgba(15,23,42,.55);
      border-color: rgba(148,163,184,.18);
      color: var(--text);
    }
    .modern-input:focus{
      background: rgba(255,255,255,.95);
      border-color: #0ea5e9;
      box-shadow: 0 0 0 4px rgba(14,165,233,.15);
      outline: none;
    }
    [data-theme="dark"] .modern-input:focus{
      background: rgba(2,6,23,.55);
    }

    #local-v {
      position: absolute;
      width: 104px; height: 146px;
      border-radius: 18px;
      border: 2px solid rgba(255,255,255,.9);
      box-shadow: 0 14px 32px rgba(0,0,0,.16);
      z-index: 50;
      touch-action: none;
      overflow: hidden;
    }
    [data-theme="dark"] #local-v { border-color: rgba(148,163,184,.22); }

    .pill {
      border: 1px solid rgba(148,163,184,.20);
      background: rgba(255,255,255,.65);
    }
    [data-theme="dark"] .pill{
      background: rgba(15,23,42,.55);
      border-color: rgba(148,163,184,.18);
    }
  </style>
</head>

<body class="w-screen h-[100dvh] flex items-center justify-center overflow-hidden" data-theme="light">

  <div id="canvas-container"></div>

  <!-- TOP BAR (theme + status) -->
  <div class="absolute top-4 left-4 right-4 z-50 flex items-center justify-between pointer-events-none">
    <div class="pointer-events-auto flex items-center gap-2 glass pill rounded-2xl px-3 py-2">
      <div class="w-2.5 h-2.5 rounded-full" id="dot" style="background:#94a3b8;"></div>
      <div class="text-[10px] font-extrabold uppercase tracking-[0.28em]" id="status" style="color:var(--muted);">–û–∂–∏–¥–∞–Ω–∏–µ</div>
    </div>

    <button id="theme-btn" class="pointer-events-auto glass pill rounded-2xl px-3 py-2 text-[10px] font-extrabold uppercase tracking-[0.28em] active:scale-95 transition"
      style="color:var(--muted);">
      –¢–µ–º–∞
    </button>
  </div>

  <!-- AUTH -->
  <section id="auth-screen" class="glass z-40 p-7 rounded-[2.25rem] w-full max-w-xs text-center space-y-5 mx-4 transition-all duration-300">
    <div class="w-28 h-28 mx-auto rounded-3xl p-1"
      style="background: linear-gradient(135deg, rgba(255,255,255,.9), rgba(56,189,248,.22)); border:1px solid rgba(255,255,255,.75); box-shadow: 0 18px 55px -28px rgba(14,165,233,.45);">
      <div class="w-full h-full rounded-2xl flex items-center justify-center"
        style="background: rgba(255,255,255,.85); border:1px solid rgba(56,189,248,.25);">
        <span class="text-5xl font-black tracking-tighter"
          style="background: linear-gradient(135deg, #0ea5e9, #38bdf8); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">DK</span>
      </div>
    </div>

    <div class="space-y-1">
      <p class="text-[10px] uppercase font-extrabold tracking-[0.42em]" style="color:var(--muted);">Premium Connection</p>
      <p class="text-[11px] font-semibold" style="color:var(--muted); opacity:.85;">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞</p>
    </div>

    <div id="symbol-pad" class="grid grid-cols-5 gap-3 mt-4"></div>

    <div class="mt-4 pt-4 border-t" style="border-color: rgba(148,163,184,.20);">
      <div class="flex items-center justify-center gap-2">
        <span class="text-[10px] uppercase tracking-[0.28em] font-extrabold" style="color:var(--muted);">–í–∞—à ID</span>
        <button id="copy-id-front" class="text-[10px] font-black px-3 py-1 rounded-xl active:scale-95 transition"
          style="background: rgba(14,165,233,.12); color:#0ea5e9; border:1px solid rgba(14,165,233,.25);">
          <span id="front-id">----</span> ‚ßâ
        </button>
      </div>
      <p class="text-[10px] mt-2" style="color:var(--muted); opacity:.75;">ID —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</p>
    </div>
  </section>

  <!-- APP -->
  <main id="app" class="absolute inset-0 z-20 hidden">
    <div class="absolute inset-0 flex items-center justify-center overflow-hidden rounded-b-[2.5rem]">
      <video id="remote-v" class="w-full h-full hidden" autoplay playsinline></video>
      <video id="local-v" class="top-4 right-4 hidden transform scale-x-[-1]" autoplay playsinline muted></video>

      <div id="video-wait" class="absolute inset-0 flex flex-col items-center justify-center glass-strong glass text-primary space-y-4">
        <div class="relative">
          <div class="w-12 h-12 border-4 rounded-full" style="border-color: rgba(148,163,184,.22);"></div>
          <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin absolute top-0 left-0"></div>
        </div>
        <p class="text-[10px] font-extrabold uppercase tracking-[0.34em]" style="color:var(--muted);">–ü–æ–∏—Å–∫ —Å–∏–≥–Ω–∞–ª–∞...</p>
      </div>
    </div>

    <footer class="absolute bottom-0 left-0 w-full z-30 pb-6 pt-4 px-4 space-y-3">
      <div id="msgs" class="max-h-44 overflow-y-auto no-scrollbar space-y-2 mb-3 px-1"></div>

      <!-- SETUP -->
      <div id="setup" class="glass p-4 rounded-3xl space-y-3">
        <div class="flex items-center justify-between px-1">
          <div class="text-[10px] uppercase tracking-[0.28em] font-extrabold" style="color:var(--muted);">
            –í–∞—à ID: <span id="display-id" class="font-black" style="color:#0ea5e9;">----</span>
            <button id="copy-id" class="ml-2 px-2 py-1 rounded-xl active:scale-95 transition"
              style="background: rgba(14,165,233,.12); color:#0ea5e9; border:1px solid rgba(14,165,233,.25);">‚ßâ</button>
          </div>

          <button id="reset-btn" class="text-[10px] font-extrabold uppercase tracking-[0.28em] px-2 py-1 rounded-xl active:scale-95 transition"
            style="background: rgba(244,63,94,.10); color:#fb7185; border:1px solid rgba(244,63,94,.22);">
            –°–±—Ä–æ—Å
          </button>
        </div>

        <div class="flex gap-3">
          <input id="target-id" type="text" inputmode="latin" autocomplete="off" spellcheck="false"
            placeholder="ID –Ω–∞–ø–∞—Ä–Ω–∏–∫–∞"
            class="flex-1 modern-input rounded-2xl px-4 py-3 text-sm font-black uppercase tracking-widest text-center" />
          <button id="connect-btn"
            class="px-6 py-3 rounded-2xl text-xs font-black uppercase active:scale-95 transition-all"
            style="background: linear-gradient(90deg, #0ea5e9, #38bdf8); color:white; box-shadow: 0 18px 45px -28px rgba(14,165,233,.75);">
            –°–í–Ø–ó–¨
          </button>
        </div>

        <div class="text-[10px] px-1" style="color:var(--muted); opacity:.8;">
          –ü–æ–¥—Å–∫–∞–∑–∫–∞: –æ–±–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—ã–±–∏—Ä–∞—é—Ç <b>–æ–¥–∏–Ω–∞–∫–æ–≤—ã–π</b> –∫–ª—é—á (üëΩ/üöÄ/‚Ä¶).
        </div>
      </div>

      <!-- CHAT -->
      <div id="chat" class="hidden glass-strong glass p-4 rounded-[2rem] items-center gap-3">
        <button id="call-btn" class="p-3 rounded-2xl text-xl active:scale-95 transition"
          style="background: rgba(14,165,233,.10); border:1px solid rgba(14,165,233,.22);">üìπ</button>

        <button id="hang-btn" class="p-3 rounded-2xl text-xl active:scale-95 transition"
          style="background: rgba(244,63,94,.10); border:1px solid rgba(244,63,94,.22);">‚õî</button>

        <input id="msg-in" type="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" autocomplete="off"
          class="flex-1 modern-input rounded-2xl px-5 py-3 text-sm font-semibold" />

        <button id="send-btn"
          class="px-6 py-3 rounded-2xl font-black text-lg active:scale-95 transition-all"
          style="background: linear-gradient(135deg, #6366f1, #a855f7); color:white; box-shadow: 0 18px 45px -28px rgba(99,102,241,.75);">
          ‚û§
        </button>
      </div>
    </footer>
  </main>

<script>
(() => {
  /* ------------------ tiny helpers ------------------ */
  const $ = (id) => document.getElementById(id);
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
  const safeUpper = (s) => (s || "").replace(/[^a-zA-Z0-9]/g, "").slice(0, 8).toUpperCase();

  function setStatus(text, kind = "idle") {
    const dot = $("dot");
    const st = $("status");
    st.textContent = text;
    const map = {
      idle: "#94a3b8",
      ok: "#22c55e",
      warn: "#f59e0b",
      err: "#ef4444",
      link: "#0ea5e9"
    };
    dot.style.background = map[kind] || map.idle;
  }

  async function copyText(t) {
    try {
      await navigator.clipboard.writeText(t);
      addSys("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: " + t);
    } catch {
      // fallback
      const ta = document.createElement("textarea");
      ta.value = t;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      addSys("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: " + t);
    }
  }

  /* ------------------ theme ------------------ */
  const themeKey = "galaxyTheme";
  const themeBtn = $("theme-btn");
  function applyTheme(t) {
    document.body.dataset.theme = t;
    localStorage.setItem(themeKey, t);
  }
  applyTheme(localStorage.getItem(themeKey) || "light");
  themeBtn.addEventListener("click", () => {
    applyTheme(document.body.dataset.theme === "dark" ? "light" : "dark");
  });

  /* ------------------ THREE background (lighter) ------------------ */
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 120);
  camera.position.z = 6;

  const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setClearColor(0x000000, 0);
  $("canvas-container").appendChild(renderer.domElement);

  const starGeo = new THREE.BufferGeometry();
  const COUNT = 9000; // –º–µ–Ω—å—à–µ = –±—ã—Å—Ç—Ä–µ–µ –Ω–∞ –º–æ–±–∏–ª–µ
  const starPos = new Float32Array(COUNT * 3);
  for (let i = 0; i < COUNT * 3; i++) starPos[i] = (Math.random() - 0.5) * 18;
  starGeo.setAttribute("position", new THREE.BufferAttribute(starPos, 3));

  const stars = new THREE.Points(
    starGeo,
    new THREE.PointsMaterial({ size: 0.02, color: 0x94a3b8, transparent: true, opacity: 0.22 })
  );
  scene.add(stars);

  let raf = 0;
  function animate() {
    stars.rotation.y += 0.00012;
    stars.rotation.x += 0.00004;
    renderer.render(scene, camera);
    raf = requestAnimationFrame(animate);
  }
  animate();

  function onResize() {
    renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
  }
  window.addEventListener("resize", onResize, { passive: true });

  /* ------------------ ID + auth ------------------ */
  const idKey = "myGalaxyId";
  let myId = localStorage.getItem(idKey);
  if (!myId) {
    myId = Math.random().toString(36).substring(2, 6).toUpperCase();
    localStorage.setItem(idKey, myId);
  }

  $("front-id").textContent = myId;
  $("display-id").textContent = myId;

  $("copy-id-front").addEventListener("click", () => copyText(myId));
  $("copy-id").addEventListener("click", () => copyText(myId));

  const lastTargetKey = "lastTarget";
  const lastTarget = localStorage.getItem(lastTargetKey);
  if (lastTarget) $("target-id").value = lastTarget;

  /* ------------------ UI messages ------------------ */
  const msgs = $("msgs");
  function addSys(text) {
    const d = document.createElement("div");
    d.className = "text-center text-[10px] font-extrabold uppercase tracking-[0.28em] py-2";
    d.style.color = "var(--muted)";
    d.textContent = text;
    msgs.appendChild(d);
    msgs.scrollTop = msgs.scrollHeight;
  }

  function addChat(text, mine) {
    const row = document.createElement("div");
    row.className = "flex " + (mine ? "justify-end" : "justify-start");

    const bubble = document.createElement("div");
    bubble.className = "px-4 py-3 rounded-2xl text-sm max-w-[85%] shadow-md font-semibold leading-tight";
    bubble.style.border = mine ? "none" : "1px solid rgba(148,163,184,.18)";
    bubble.style.background = mine
      ? "linear-gradient(135deg, #0ea5e9, #38bdf8)"
      : (document.body.dataset.theme === "dark" ? "rgba(15,23,42,.55)" : "rgba(255,255,255,.85)");
    bubble.style.color = mine ? "white" : "var(--text)";

    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ: —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç, –±–µ–∑ HTML
    bubble.textContent = text;

    row.appendChild(bubble);
    msgs.appendChild(row);
    msgs.scrollTop = msgs.scrollHeight;
  }

  /* ------------------ peer/video state ------------------ */
  const localV = $("local-v");
  const remoteV = $("remote-v");
  const videoWait = $("video-wait");

  let roomPass = "";
  let peer = null;
  let conn = null;
  let localStream = null;
  let activeCall = null;

  function stopStream(s) {
    if (!s) return;
    s.getTracks().forEach(t => { try { t.stop(); } catch {} });
  }

  function resetVideoUI() {
    remoteV.srcObject = null;
    localV.srcObject = null;
    remoteV.classList.add("hidden");
    localV.classList.add("hidden");
    videoWait.style.display = "flex";
  }

  async function getMedia() {
    try {
      return await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    } catch (e) {
      addSys("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É");
      setStatus("–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞", "err");
      throw e;
    }
  }

  function showApp() {
    $("auth-screen").style.opacity = "0";
    $("auth-screen").style.transform = "scale(.97) translateY(16px)";
    setTimeout(() => {
      $("auth-screen").style.display = "none";
      $("app").classList.remove("hidden");
    }, 260);
  }

  /* ------------------ symbol pad ------------------ */
  const sysCode = [
    { i: "üëΩ", v: "alien" },
    { i: "üöÄ", v: "rocket" },
    { i: "üõ∞Ô∏è", v: "sat" },
    { i: "üõ∏", v: "ufo" },
    { i: "üåç", v: "earth" },
    { i: "üåô", v: "moon" },
    { i: "ü™ê", v: "planet" },
    { i: "‚òÑÔ∏è", v: "comet" },
    { i: "ü§ñ", v: "bot" },
    { i: "‚ò¢Ô∏è", v: "nuke" }
  ];

  const pad = $("symbol-pad");
  sysCode.forEach(s => {
    const btn = document.createElement("button");
    btn.className = "sym-btn rounded-2xl text-2xl py-4 flex justify-center items-center";
    btn.textContent = s.i;
    btn.addEventListener("click", async () => {
      roomPass = s.v;
      showApp();
      await sleep(260);
      initPeer();
    });
    pad.appendChild(btn);
  });

  /* ------------------ PeerJS init ------------------ */
  function initPeer() {
    // –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ—Å–ª–∏ —É–∂–µ –±—ã–ª–æ
    try { if (peer) peer.destroy(); } catch {}
    peer = null;

    const peerId = `${roomPass}-${myId.toLowerCase()}`;

    setStatus("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ‚Ä¶", "link");

    peer = new Peer(peerId, {
      config: {
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "turn:openrelay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
          { urls: "turn:openrelay.metered.ca:443", username: "openrelayproject", credential: "openrelayproject" },
          { urls: "turn:openrelay.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
        ]
      }
    });

    peer.on("open", () => {
      setStatus("–ì–æ—Ç–æ–≤–æ", "ok");
      addSys("–°–µ—Ç—å –∞–∫—Ç–∏–≤–Ω–∞");
    });

    peer.on("error", (e) => {
      console.error(e);
      setStatus("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", "err");
      addSys("–û—à–∏–±–∫–∞ PeerJS: " + (e?.type || "unknown"));
    });

    peer.on("connection", (c) => {
      conn = c;
      bindConn();
    });

    peer.on("call", async (call) => {
      // –ü—Ä–æ—Å—Ç–æ–π confirm ‚Äî –æ–∫, –Ω–æ –±–µ–∑ ‚Äú–∑–∞–ª–∏–ø–∞–Ω–∏—è‚Äù
      const ok = confirm("–í—Ö–æ–¥—è—â–∏–π –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫. –ü—Ä–∏–Ω—è—Ç—å?");
      if (!ok) { try { call.close(); } catch {} ; return; }

      try {
        localStream = await getMedia();
        localV.srcObject = localStream;
        localV.classList.remove("hidden");

        activeCall = call;
        call.answer(localStream);

        call.on("stream", (s) => {
          remoteV.srcObject = s;
          remoteV.classList.remove("hidden");
          videoWait.style.display = "none";
          setStatus("–í–∏–¥–µ–æ –∞–∫—Ç–∏–≤–Ω–æ", "ok");
          addSys("–í–∏–¥–µ–æ—Å–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞");
        });

        call.on("close", ()
