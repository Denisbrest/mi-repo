<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Galactic Chat 3.1</title>
    <!-- –°—Ç–∏–ª–∏ –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; color: white; font-family: sans-serif; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; }
        .glass-panel {
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .msg-anim { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="h-screen w-screen relative flex items-center justify-center">

    <!-- –§–û–ù: 100 000 –ó–í–ï–ó–î -->
    <div id="canvas-container"></div>

    <!-- –ò–ù–¢–ï–†–§–ï–ô–° –ú–ï–°–°–ï–ù–î–ñ–ï–†–ê -->
    <main class="glass-panel w-full max-w-md h-[100dvh] sm:h-[85vh] sm:rounded-3xl flex flex-col relative z-10 overflow-hidden">
        
        <!-- –®–∞–ø–∫–∞ -->
        <header class="p-4 border-b border-white/10 flex flex-col gap-2 bg-black/20">
            <div class="flex justify-between items-center">
                <h1 class="font-bold text-emerald-400 tracking-wider">GALAXY CHAT</h1>
                <span id="conn-status" class="text-xs px-2 py-1 rounded-full bg-yellow-500/20 text-yellow-300 border border-yellow-500/30 animate-pulse">
                    –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...
                </span>
            </div>
            <div class="flex items-center gap-2 bg-black/40 p-2 rounded-xl border border-white/5">
                <span class="text-xs text-gray-400 whitespace-nowrap">–¢–≤–æ–π –∫–æ–¥:</span>
                <input type="text" id="my-id" readonly class="bg-transparent text-emerald-300 font-mono text-sm w-full outline-none select-all" value="–ñ–¥–µ–º —Å–µ—Ç—å...">
            </div>
        </header>

        <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ -->
        <div id="connect-zone" class="p-4 flex gap-2 border-b border-white/10 bg-white/5">
            <input type="text" id="target-id" placeholder="–ö–æ–¥ –Ω–∞–ø–∞—Ä–Ω–∏–∫–∞..." class="flex-1 bg-black/50 border border-white/10 rounded-xl px-3 py-2 text-sm text-white focus:outline-none focus:border-emerald-500 placeholder-gray-500 font-mono">
            <button id="connect-btn" class="bg-emerald-600/80 hover:bg-emerald-500 text-white px-4 py-2 rounded-xl text-sm font-bold transition">–°–≤—è–∑—å</button>
        </div>

        <!-- –í–∏–¥–µ–æ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∑–≤–æ–Ω–∫–µ) -->
        <div id="video-zone" class="relative w-full aspect-video bg-black/80 hidden flex-shrink-0 border-b border-white/10">
            <video id="remote-video" class="w-full h-full object-cover" autoplay playsinline></video>
            <video id="local-video" class="absolute bottom-2 right-2 w-24 rounded-lg border border-emerald-500/50 object-cover shadow-lg transform scale-x-[-1]" autoplay playsinline muted></video>
            <button id="end-call-btn" class="absolute top-2 right-2 bg-red-600/80 hover:bg-red-500 p-2 rounded-full text-white backdrop-blur-md">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-3 no-scrollbar flex flex-col relative">
            <div class="text-center text-xs text-gray-500 mt-auto italic">–ü—Ä—è–º–æ–µ P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.</div>
        </div>

        <!-- –í–≤–æ–¥ -->
        <form id="msg-form" class="p-3 bg-black/30 border-t border-white/10 flex gap-2">
            <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ –≤ —ç—Ñ–∏—Ä..." class="flex-1 bg-black/50 border border-white/10 rounded-xl px-4 py-2 text-sm text-white focus:outline-none focus:border-emerald-500 disabled:opacity-50" disabled>
            <button type="submit" id="send-btn" class="bg-indigo-600/80 hover:bg-indigo-500 text-white p-2 rounded-xl transition disabled:opacity-50" disabled>
                <svg class="w-5 h-5 translate-x-0.5 -translate-y-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg>
            </button>
        </form>
    </main>

    <!-- –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –ß–ê–°–¢–¨ -->
    <script>
        // --- –ì–†–ê–§–ò–ö–ê: THREE.JS ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(3, 3, 3);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const params = { count: 100000, size: 0.012, radius: 5, branches: 4, spin: 1.2, randomness: 0.2, power: 3, inside: '#10b981', outside: '#3b82f6' };
        
        let geometry = new THREE.BufferGeometry();
        const positions = new Float32Array(params.count * 3);
        const colors = new Float32Array(params.count * 3);
        const colorInside = new THREE.Color(params.inside);
        const colorOutside = new THREE.Color(params.outside);

        for(let i=0; i<params.count; i++) {
            const i3 = i*3;
            const r = Math.random() * params.radius;
            const spinAngle = r * params.spin;
            const branchAngle = (i % params.branches) / params.branches * Math.PI * 2;

            const rx = Math.pow(Math.random(), params.power) * (Math.random()<0.5?1:-1) * params.randomness * r;
            const ry = Math.pow(Math.random(), params.power) * (Math.random()<0.5?1:-1) * params.randomness * r;
            const rz = Math.pow(Math.random(), params.power) * (Math.random()<0.5?1:-1) * params.randomness * r;

            positions[i3] = Math.cos(branchAngle + spinAngle) * r + rx;
            positions[i3+1] = ry;
            positions[i3+2] = Math.sin(branchAngle + spinAngle) * r + rz;

            const mixed = colorInside.clone().lerp(colorOutside, r/params.radius);
            colors[i3] = mixed.r; colors[i3+1] = mixed.g; colors[i3+2] = mixed.b;
        }

        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
        const material = new THREE.PointsMaterial({ size: params.size, sizeAttenuation: true, depthWrite: false, blending: THREE.AdditiveBlending, vertexColors: true });
        const points = new THREE.Points(geometry, material);
        scene.add(points);

        let targetX = 0, targetY = 0;
        document.addEventListener('mousemove', (e) => {
            targetX = (e.clientX - window.innerWidth/2) * 0.001;
            targetY = (e.clientY - window.innerHeight/2) * 0.001;
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        const clock = new THREE.Clock();
        const tick = () => {
            const time = clock.getElapsedTime();
            points.rotation.y = time * 0.03;
            points.rotation.x += 0.05 * (targetY - points.rotation.x);
            points.rotation.y += 0.05 * (targetX - points.rotation.y);
            renderer.render(scene, camera);
            requestAnimationFrame(tick);
        }
        tick();

        // --- –õ–û–ì–ò–ö–ê: PEERJS (P2P –°–í–Ø–ó–¨) ---
        const peerId = 'agent-' + Math.random().toString(36).substring(2, 7);
        const peer = new Peer(peerId);

        const myIdEl = document.getElementById('my-id');
        const connStatus = document.getElementById('conn-status');
        const chatBox = document.getElementById('chat-box');
        const msgInput = document.getElementById('msg-input');
        const sendBtn = document.getElementById('send-btn');
        const videoZone = document.getElementById('video-zone');

        let dataConnection = null;
        let mediaConnection = null;
        let localStream = null;

        peer.on('open', (id) => {
            myIdEl.value = id;
            connStatus.textContent = '–í —Å–µ—Ç–∏';
            connStatus.className = 'text-xs px-2 py-1 rounded-full bg-emerald-500/20 text-emerald-300 border border-emerald-500/30';
        });

        const printMsg = (text, isMine = false, isSys = false) => {
            const div = document.createElement('div');
            if(isSys) {
                div.className = 'text-center text-[10px] text-emerald-400/50 my-2 font-mono msg-anim uppercase tracking-tighter';
                div.textContent = `[–°–ò–°–¢–ï–ú–ê]: ${text}`;
            } else {
                div.className = `flex ${isMine ? 'justify-end' : 'justify-start'} msg-anim mb-2`;
                div.innerHTML = `<div class="${isMine ? 'bg-emerald-600/90 text-white rounded-tr-none' : 'bg-white/10 text-gray-200 border border-white/10 rounded-tl-none'} px-4 py-2 rounded-2xl max-w-[85%] text-sm shadow-lg backdrop-blur-md">${text}</div>`;
            }
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        };

        const initConn = (conn) => {
            dataConnection = conn;
            conn.on('open', () => {
                printMsg('–ö–∞–Ω–∞–ª —Å–≤—è–∑–∏ –æ—Ç–∫—Ä—ã—Ç.', false, true);
                msgInput.disabled = false; sendBtn.disabled = false;
                document.getElementById('connect-btn').textContent = 'üé• –ó–í–û–ù–û–ö';
                document.getElementById('target-id').disabled = true;
            });
            conn.on('data', data => printMsg(data, false));
            conn.on('close', () => {
                printMsg('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ —É—à–µ–ª —Å–æ —Å–≤—è–∑–∏.', false, true);
                location.reload(); // –ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë
            });
        };

        peer.on('connection', initConn);

        peer.on('call', async (call) => {
            if(confirm('–í—Ö–æ–¥—è—â–∏–π –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫. –ü—Ä–∏–Ω–∏–º–∞–µ–º?')) {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('local-video').srcObject = localStream;
                videoZone.classList.remove('hidden');
                call.answer(localStream);
                mediaConnection = call;
                call.on('stream', stream => document.getElementById('remote-video').srcObject = stream);
            }
        });

        document.getElementById('connect-btn').onclick = async () => {
            const tid = document.getElementById('target-id').value.trim();
            if(!tid) return;
            if(!dataConnection) initConn(peer.connect(tid));
            else {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('local-video').srcObject = localStream;
                videoZone.classList.remove('hidden');
                const call = peer.call(tid, localStream);
                mediaConnection = call;
                call.on('stream', stream => document.getElementById('remote-video').srcObject = stream);
            }
        };

        document.getElementById('msg-form').onsubmit = (e) => {
            e.preventDefault();
            const t = msgInput.value.trim();
            if(t && dataConnection) {
                dataConnection.send(t);
                printMsg(t, true);
                msgInput.value = '';
            }
        };

        document.getElementById('end-call-btn').onclick = () => {
            if(mediaConnection) mediaConnection.close();
            videoZone.classList.add('hidden');
            if(localStream) localStream.getTracks().forEach(t => t.stop());
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Galactic Chat 3.1</title>
    <!-- –°—Ç–∏–ª–∏ –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; color: white; font-family: sans-serif; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; }
        .glass-panel {
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .msg-anim { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="h-screen w-screen relative flex items-center justify-center">

    <!-- –§–û–ù: 100 000 –ó–í–ï–ó–î -->
    <div id="canvas-container"></div>

    <!-- –ò–ù–¢–ï–†–§–ï–ô–° –ú–ï–°–°–ï–ù–î–ñ–ï–†–ê -->
    <main class="glass-panel w-full max-w-md h-[100dvh] sm:h-[85vh] sm:rounded-3xl flex flex-col relative z-10 overflow-hidden">
        
        <!-- –®–∞–ø–∫–∞ -->
        <header class="p-4 border-b border-white/10 flex flex-col gap-2 bg-black/20">
            <div class="flex justify-between items-center">
                <h1 class="font-bold text-emerald-400 tracking-wider">GALAXY CHAT</h1>
                <span id="conn-status" class="text-xs px-2 py-1 rounded-full bg-yellow-500/20 text-yellow-300 border border-yellow-500/30 animate-pulse">
                    –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...
                </span>
            </div>
            <div class="flex items-center gap-2 bg-black/40 p-2 rounded-xl border border-white/5">
                <span class="text-xs text-gray-400 whitespace-nowrap">–¢–≤–æ–π –∫–æ–¥:</span>
                <input type="text" id="my-id" readonly class="bg-transparent text-emerald-300 font-mono text-sm w-full outline-none select-all" value="–ñ–¥–µ–º —Å–µ—Ç—å...">
            </div>
        </header>

        <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ -->
        <div id="connect-zone" class="p-4 flex gap-2 border-b border-white/10 bg-white/5">
            <input type="text" id="target-id" placeholder="–ö–æ–¥ –Ω–∞–ø–∞—Ä–Ω–∏–∫–∞..." class="flex-1 bg-black/50 border border-white/10 rounded-xl px-3 py-2 text-sm text-white focus:outline-none focus:border-emerald-500 placeholder-gray-500 font-mono">
            <button id="connect-btn" class="bg-emerald-600/80 hover:bg-emerald-500 text-white px-4 py-2 rounded-xl text-sm font-bold transition">–°–≤—è–∑—å</button>
        </div>

        <!-- –í–∏–¥–µ–æ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∑–≤–æ–Ω–∫–µ) -->
        <div id="video-zone" class="relative w-full aspect-video bg-black/80 hidden flex-shrink-0 border-b border-white/10">
            <video id="remote-video" class="w-full h-full object-cover" autoplay playsinline></video>
            <video id="local-video" class="absolute bottom-2 right-2 w-24 rounded-lg border border-emerald-500/50 object-cover shadow-lg transform scale-x-[-1]" autoplay playsinline muted></video>
            <button id="end-call-btn" class="absolute top-2 right-2 bg-red-600/80 hover:bg-red-500 p-2 rounded-full text-white backdrop-blur-md">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-3 no-scrollbar flex flex-col relative">
            <div class="text-center text-xs text-gray-500 mt-auto italic">–ü—Ä—è–º–æ–µ P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.</div>
        </div>

        <!-- –í–≤–æ–¥ -->
        <form id="msg-form" class="p-3 bg-black/30 border-t border-white/10 flex gap-2">
            <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ –≤ —ç—Ñ–∏—Ä..." class="flex-1 bg-black/50 border border-white/10 rounded-xl px-4 py-2 text-sm text-white focus:outline-none focus:border-emerald-500 disabled:opacity-50" disabled>
            <button type="submit" id="send-btn" class="bg-indigo-600/80 hover:bg-indigo-500 text-white p-2 rounded-xl transition disabled:opacity-50" disabled>
                <svg class="w-5 h-5 translate-x-0.5 -translate-y-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg>
            </button>
        </form>
    </main>

    <!-- –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –ß–ê–°–¢–¨ -->
    <script>
        // --- –ì–†–ê–§–ò–ö–ê: THREE.JS ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(3, 3, 3);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const params = { count: 100000, size: 0.012, radius: 5, branches: 4, spin: 1.2, randomness: 0.2, power: 3, inside: '#10b981', outside: '#3b82f6' };
        
        let geometry = new THREE.BufferGeometry();
        const positions = new Float32Array(params.count * 3);
        const colors = new Float32Array(params.count * 3);
        const colorInside = new THREE.Color(params.inside);
        const colorOutside = new THREE.Color(params.outside);

        for(let i=0; i<params.count; i++) {
            const i3 = i*3;
            const r = Math.random() * params.radius;
            const spinAngle = r * params.spin;
            const branchAngle = (i % params.branches) / params.branches * Math.PI * 2;

            const rx = Math.pow(Math.random(), params.power) * (Math.random()<0.5?1:-1) * params.randomness * r;
            const ry = Math.pow(Math.random(), params.power) * (Math.random()<0.5?1:-1) * params.randomness * r;
            const rz = Math.pow(Math.random(), params.power) * (Math.random()<0.5?1:-1) * params.randomness * r;

            positions[i3] = Math.cos(branchAngle + spinAngle) * r + rx;
            positions[i3+1] = ry;
            positions[i3+2] = Math.sin(branchAngle + spinAngle) * r + rz;

            const mixed = colorInside.clone().lerp(colorOutside, r/params.radius);
            colors[i3] = mixed.r; colors[i3+1] = mixed.g; colors[i3+2] = mixed.b;
        }

        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
        const material = new THREE.PointsMaterial({ size: params.size, sizeAttenuation: true, depthWrite: false, blending: THREE.AdditiveBlending, vertexColors: true });
        const points = new THREE.Points(geometry, material);
        scene.add(points);

        let targetX = 0, targetY = 0;
        document.addEventListener('mousemove', (e) => {
            targetX = (e.clientX - window.innerWidth/2) * 0.001;
            targetY = (e.clientY - window.innerHeight/2) * 0.001;
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        const clock = new THREE.Clock();
        const tick = () => {
            const time = clock.getElapsedTime();
            points.rotation.y = time * 0.03;
            points.rotation.x += 0.05 * (targetY - points.rotation.x);
            points.rotation.y += 0.05 * (targetX - points.rotation.y);
            renderer.render(scene, camera);
            requestAnimationFrame(tick);
        }
        tick();

        // --- –õ–û–ì–ò–ö–ê: PEERJS (P2P –°–í–Ø–ó–¨) ---
        const peerId = 'agent-' + Math.random().toString(36).substring(2, 7);
        const peer = new Peer(peerId);

        const myIdEl = document.getElementById('my-id');
        const connStatus = document.getElementById('conn-status');
        const chatBox = document.getElementById('chat-box');
        const msgInput = document.getElementById('msg-input');
        const sendBtn = document.getElementById('send-btn');
        const videoZone = document.getElementById('video-zone');

        let dataConnection = null;
        let mediaConnection = null;
        let localStream = null;

        peer.on('open', (id) => {
            myIdEl.value = id;
            connStatus.textContent = '–í —Å–µ—Ç–∏';
            connStatus.className = 'text-xs px-2 py-1 rounded-full bg-emerald-500/20 text-emerald-300 border border-emerald-500/30';
        });

        const printMsg = (text, isMine = false, isSys = false) => {
            const div = document.createElement('div');
            if(isSys) {
                div.className = 'text-center text-[10px] text-emerald-400/50 my-2 font-mono msg-anim uppercase tracking-tighter';
                div.textContent = `[–°–ò–°–¢–ï–ú–ê]: ${text}`;
            } else {
                div.className = `flex ${isMine ? 'justify-end' : 'justify-start'} msg-anim mb-2`;
                div.innerHTML = `<div class="${isMine ? 'bg-emerald-600/90 text-white rounded-tr-none' : 'bg-white/10 text-gray-200 border border-white/10 rounded-tl-none'} px-4 py-2 rounded-2xl max-w-[85%] text-sm shadow-lg backdrop-blur-md">${text}</div>`;
            }
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        };

        const initConn = (conn) => {
            dataConnection = conn;
            conn.on('open', () => {
                printMsg('–ö–∞–Ω–∞–ª —Å–≤—è–∑–∏ –æ—Ç–∫—Ä—ã—Ç.', false, true);
                msgInput.disabled = false; sendBtn.disabled = false;
                document.getElementById('connect-btn').textContent = 'üé• –ó–í–û–ù–û–ö';
                document.getElementById('target-id').disabled = true;
            });
            conn.on('data', data => printMsg(data, false));
            conn.on('close', () => {
                printMsg('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ —É—à–µ–ª —Å–æ —Å–≤—è–∑–∏.', false, true);
                location.reload(); // –ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë
            });
        };

        peer.on('connection', initConn);

        peer.on('call', async (call) => {
            if(confirm('–í—Ö–æ–¥—è—â–∏–π –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫. –ü—Ä–∏–Ω–∏–º–∞–µ–º?')) {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('local-video').srcObject = localStream;
                videoZone.classList.remove('hidden');
                call.answer(localStream);
                mediaConnection = call;
                call.on('stream', stream => document.getElementById('remote-video').srcObject = stream);
            }
        });

        document.getElementById('connect-btn').onclick = async () => {
            const tid = document.getElementById('target-id').value.trim();
            if(!tid) return;
            if(!dataConnection) initConn(peer.connect(tid));
            else {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('local-video').srcObject = localStream;
                videoZone.classList.remove('hidden');
                const call = peer.call(tid, localStream);
                mediaConnection = call;
                call.on('stream', stream => document.getElementById('remote-video').srcObject = stream);
            }
        };

        document.getElementById('msg-form').onsubmit = (e) => {
            e.preventDefault();
            const t = msgInput.value.trim();
            if(t && dataConnection) {
                dataConnection.send(t);
                printMsg(t, true);
                msgInput.value = '';
            }
        };

        document.getElementById('end-call-btn').onclick = () => {
            if(mediaConnection) mediaConnection.close();
            videoZone.classList.add('hidden');
            if(localStream) localStream.getTracks().forEach(t => t.stop());
        };
    </script>
</body>
</html>
