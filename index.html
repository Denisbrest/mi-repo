<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>–û–º–µ–≥–∞ 2.0 | CARDIOGRAM</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <style>
    :root{ --p:#0ea5e9; --p2:#38bdf8; --bg1:#f0f9ff; --bg2:#e0f2fe; --t:#0f172a; --m:#64748b; --g: rgba(255,255,255,.72); --st: rgba(226,232,240,.95); --sh: rgba(2,132,199,.20); }
    *{ box-sizing:border-box; } body{ margin:0; overflow:hidden; touch-action:none; font-family: Inter, sans-serif; background: linear-gradient(135deg,var(--bg1),var(--bg2)); color:var(--t); height:100%; }
    .status{ position:absolute; top:14px; left:14px; z-index:50; display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:16px; background:var(--g); border:1px solid var(--st); backdrop-filter: blur(14px); }
    .dot{ width:10px; height:10px; border-radius:999px; background:#94a3b8; }
    .stxt{ font-size:10px; font-weight:800; letter-spacing:.28em; text-transform:uppercase; color:var(--m); }
    .wrap{ position:relative; z-index:10; width:100%; height:100%; display:flex; align-items:center; justify-content:center; padding:16px; }
    .card{ width:min(380px, 92vw); border-radius:34px; background:var(--g); border:1px solid var(--st); box-shadow:0 18px 60px -26px var(--sh); backdrop-filter:blur(18px); padding:28px; text-align:center; }
    .logo{ width:80px; height:80px; margin:0 auto 15px; border-radius:22px; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg, var(--p), var(--p2)); color:white; font-size:42px; font-weight:900; }
    .pad{ display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; margin:20px 0; }
    .btn{ height:50px; border-radius:14px; border:1px solid var(--st); background:#fff; font-size:20px; transition:0.1s; }
    .btn:active{ transform:scale(0.9); background:var(--p); color:white; }
    .chip{ padding:6px 12px; background:rgba(14,165,233,.1); border-radius:10px; color:var(--p); font-weight:800; }
    #app{ display:none; position:fixed; inset:0; background:#f8fafc; z-index:100; }
    #video-zone{ position:relative; height:60%; background:#000; overflow:hidden; }
    video{ width:100%; height:100%; object-fit:cover; }
    #local-v{ position:absolute; top:10px; right:10px; width:100px; height:140px; border-radius:12px; border:2px solid #fff; }
    .controls{ padding:20px; display:flex; flex-direction:column; gap:10px; }
    .in{ height:50px; border-radius:15px; border:1px solid #cbd5e1; text-align:center; font-weight:800; font-size:18px; }
    .cta{ height:50px; border-radius:15px; background:var(--p); color:white; border:none; font-weight:800; }
  </style>
</head>
<body>
  <div class="status"><div id="dot" class="dot"></div><div id="status" class="stxt">OFFLINE</div></div>
  
  <div class="wrap" id="authWrap">
    <div class="card">
      <div class="logo">Œ©2</div>
      <div class="stxt">CARDIOGRAM 2.0</div>
      <div class="pad" id="symbols"></div>
      <div style="font-size:12px; font-weight:800; color:var(--m)">ID: <span class="chip" id="my-id">...</span></div>
    </div>
  </div>

  <div id="app">
    <div id="video-zone">
      <video id="remote-v" autoplay playsinline></video>
      <video id="local-v" autoplay playsinline muted></video>
    </div>
    <div class="controls">
      <input class="in" id="target-id" placeholder="ID –ù–ê–ü–ê–†–ù–ò–ö–ê" />
      <button class="cta" id="conn-btn">–£–°–¢–ê–ù–û–í–ò–¢–¨ –°–í–Ø–ó–¨</button>
      <div id="call-btns" style="display:none; gap:10px;">
        <button class="cta" id="v-btn" style="flex:1">–í–ò–î–ï–û</button>
        <button class="cta" style="flex:1; background:#ef4444;" onclick="location.reload()">–°–ë–†–û–°</button>
      </div>
    </div>
  </div>

<script>
const $ = (id) => document.getElementById(id);
let peer, conn, myId = Math.random().toString(36).substring(2,6).toUpperCase();
let room = "";

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ —Ç–≤–æ–µ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ Metered (Open Relay)
const iceConfig = {
  iceServers: [
    { urls: "stun:stun.l.google.com:19302" },
    { urls: "turn:open-relay.metered.ca:80", username: "0d0bf8d106dd90657dca0a1d", credential: "2D4ts2w87TtkX1xU" },
    { urls: "turn:open-relay.metered.ca:443", username: "0d0bf8d106dd90657dca0a1d", credential: "2D4ts2w87TtkX1xU" },
    { urls: "turns:open-relay.metered.ca:443?transport=tcp", username: "0d0bf8d106dd90657dca0a1d", credential: "2D4ts2w87TtkX1xU" }
  ],
  iceTransportPolicy: 'all'
};

const syms = ['üëΩ','üöÄ','üõ∞Ô∏è','üõ∏','ü§ñ'];
syms.forEach(s => {
  const b = document.createElement("button"); b.className="btn"; b.textContent=s;
  b.onclick = () => { room = s; $("authWrap").style.display="none"; $("app").style.display="block"; init(); };
  $("symbols").appendChild(b);
});

$("my-id").textContent = myId;

function init() {
  peer = new Peer(room + "-" + myId, { config: iceConfig, debug: 2 });
  
  peer.on('open', (id) => { $("status").textContent="READY"; $("dot").style.background="#22c55e"; });
  peer.on('error', (err) => { alert("–û—à–∏–±–∫–∞: " + err.type); location.reload(); });
  
  peer.on('connection', (c) => { 
    conn = c; 
    $("conn-btn").style.display="none"; $("call-btns").style.display="flex";
    $("status").textContent="CONNECTED";
  });

  peer.on('call', async (call) => {
    if(confirm("–í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤! –û—Ç–≤–µ—Ç–∏—Ç—å?")) {
      const stream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
      $("local-v").srcObject = stream;
      call.answer(stream);
      call.on('stream', (rs) => { $("remote-v").srcObject = rs; });
    }
  });
}

$("conn-btn").onclick = () => {
  const tid = $("target-id").value.trim().toUpperCase();
  if(!tid) return;
  conn = peer.connect(room + "-" + tid);
  conn.on('open', () => { 
    $("conn-btn").style.display="none"; $("call-btns").style.display="flex"; 
    $("status").textContent="CONNECTED";
  });
};

$("v-btn").onclick = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
  $("local-v").srcObject = stream;
  const call = peer.call(conn.peer, stream);
  call.on('stream', (rs) => { $("remote-v").srcObject = rs; });
};
</script>
</body>
</html>
