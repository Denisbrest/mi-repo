<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>DNK | –û–º–µ–≥–∞ 3.1 VIP</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

  <script defer src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

  <style>
    :root{
      --p:#0ea5e9; --p2:#38bdf8; --bg1:#f0f9ff; --bg2:#e0f2fe;
      --t:#0f172a; --m:#64748b; --glass: rgba(255,255,255,.86);
      --st: rgba(226,232,240,.92);
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; margin:0; overflow:hidden; touch-action:none; }
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      color:var(--t);
    }

    .bg{
      position:fixed; inset:0; pointer-events:none; opacity:.45;
      background-image: radial-gradient(rgba(148,163,184,.25) 1px, transparent 1px);
      background-size: 18px 18px;
      mask-image: radial-gradient(circle at 35% 20%, #000 0%, #000 45%, transparent 78%);
    }

    .status{
      position:fixed; top:14px; left:14px; z-index:50;
      display:flex; align-items:center; gap:10px;
      padding:10px 14px; border-radius:16px;
      background: var(--glass); border:1px solid var(--st);
      box-shadow: 0 12px 35px -25px rgba(0,0,0,.25);
      backdrop-filter: blur(14px);
    }
    .dot{ width:10px; height:10px; border-radius:999px; background:#94a3b8; transition:background .25s; }
    .stxt{ font-size:10px; font-weight:900; letter-spacing:.26em; text-transform:uppercase; color:var(--m); }

    .wrap{ position:relative; z-index:10; width:100%; height:100%; display:flex; align-items:center; justify-content:center; padding:16px; }
    .card{
      width:min(390px, 92vw); border-radius: 34px;
      background: var(--glass); border:1px solid var(--st);
      box-shadow: 0 18px 70px -35px rgba(2,132,199,.30);
      backdrop-filter: blur(18px) saturate(170%);
      padding: 28px; text-align:center;
    }

    .logoWrap{
      width:110px; height:110px; margin:0 auto 10px; border-radius: 30px; padding:6px;
      background: linear-gradient(135deg, #fff, rgba(56,189,248,.18));
      border:1px solid rgba(255,255,255,.85);
      box-shadow: 0 22px 65px -45px rgba(14,165,233,.65);
    }
    .logo{
      width:100%; height:100%; border-radius: 24px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.92); border:1px solid rgba(56,189,248,.18);
      font-weight:900; font-size:46px; letter-spacing:-2px;
      background: linear-gradient(135deg, var(--p), var(--p2));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }

    .cap{ font-size:10px; letter-spacing:.42em; text-transform:uppercase; font-weight:900; color:var(--m); }
    .sub{ margin-top:8px; font-size:12px; font-weight:800; color:#64748b; text-transform:uppercase; letter-spacing:.15em; }

    .pad{ display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; margin-top:20px; }
    .btn{
      height:50px; border-radius:16px; font-size:14px; font-weight:900; letter-spacing:.12em;
      background:#fff; border:1px solid #e2e8f0; color:var(--p);
      box-shadow: 0 10px 26px -22px rgba(0,0,0,.25);
      transition: transform .12s ease, background .12s ease, color .12s ease, border-color .12s ease;
    }
    .btn:active{ transform: scale(.96); background: var(--p); color:#fff; border-color: var(--p); }

    .row{
      margin-top:20px; padding-top:16px; border-top:1px solid #e2e8f0;
      display:flex; align-items:center; justify-content:center; gap:10px;
      font-size:11px; font-weight:900; letter-spacing:.28em; color:var(--m);
    }
    .chip{
      padding:8px 16px; min-width:88px; border-radius:14px;
      background: rgba(14,165,233,.10); color: var(--p);
      font-weight:900; letter-spacing:.18em;
      border:1px solid rgba(14,165,233,.18);
    }
    .copy{
      width:46px; height:40px; border-radius:14px; background:#fff;
      border:1px solid #e2e8f0; font-weight:900;
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 10px 22px -18px rgba(0,0,0,.25);
    }
    .copy:active{ transform: scale(.96); }
    .hint{
      margin-top:12px; font-size:11px; font-weight:800;
      color:#64748b; text-transform:uppercase; letter-spacing:.05em;
      user-select:none;
    }
    .hint b{ color: var(--p); }

    /* App */
    #app{ display:none; position:fixed; inset:0; z-index:30; background:#000; }
    #video-zone{ position:absolute; inset:0; overflow:hidden; }
    #remote-v{ width:100%; height:100%; object-fit:cover; display:none; }
    #local-v{
      position:absolute; top:14px; right:14px; width:110px; height:150px; border-radius:18px;
      border:2px solid rgba(255,255,255,.22);
      box-shadow: 0 14px 35px rgba(0,0,0,.45);
      transform: scaleX(-1);
      display:none; object-fit:cover; z-index:40;
      background:#111;
    }
    #wait{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column;
      gap:16px; background: rgba(15,23,42,.95); color: var(--p); z-index:20;
    }
    .spin{
      width:50px; height:50px; border-radius:999px;
      border:4px solid rgba(148,163,184,.12); border-top-color: var(--p);
      animation: rot 1s linear infinite;
    }
    @keyframes rot{ to{ transform: rotate(360deg); } }

    #footer{ position:absolute; left:0; right:0; bottom:30px; display:flex; flex-direction:column; align-items:center; z-index:50; padding:0 20px; }
    .panel{
      background: rgba(255,255,255,.92);
      border-radius: 24px;
      box-shadow: 0 18px 50px -30px rgba(0,0,0,.45);
      padding: 16px;
      width:100%; max-width:400px;
      backdrop-filter: blur(12px);
      border:1px solid rgba(255,255,255,.6);
    }
    .row2{ display:flex; gap:10px; align-items:center; }
    .in{
      flex:1; height:50px; border-radius: 16px; border:1px solid #cbd5e1; background:#f8fafc;
      text-align:center; font-weight:900; letter-spacing:.2em; text-transform:uppercase; outline:none;
    }
    .in:focus{ background:#fff; border-color:var(--p); }
    .cta{
      height:50px; padding:0 24px; border-radius: 16px; border:none; color:#fff;
      font-weight:900; letter-spacing:.15em; background: linear-gradient(90deg, var(--p), var(--p2));
      box-shadow: 0 14px 35px -25px rgba(14,165,233,.75);
    }
    .tiny{
      width:50px; height:50px; border-radius:16px; border:1px solid #e2e8f0; background:#fff;
      font-size:18px; font-weight:900; color:var(--m);
    }

    #controls{ display:none; justify-content:center; align-items:center; width:100%; margin-top:10px; gap:14px; }
    .circle-btn{
      width:76px; height:76px; border-radius:50%; border:none;
      box-shadow: 0 18px 45px rgba(0,0,0,.35);
      outline:none; cursor:pointer;
      transition: transform .18s cubic-bezier(.175,.885,.32,1.275), filter .18s;
      display:flex; align-items:center; justify-content:center;
      font-size:26px; color:#fff;
    }
    .circle-btn:active{ transform: scale(.86); filter:brightness(1.05); }
    .btn-blue{ background:#0ea5e9; border:3px solid rgba(255,255,255,.20); }
    .btn-green{ background:#22c55e; border:3px solid rgba(255,255,255,.20); }
  </style>
</head>

<body>
  <div class="bg"></div>
  <div class="status">
    <div id="dot" class="dot"></div>
    <div id="status" class="stxt">–û–ñ–ò–î–ê–ù–ò–ï</div>
  </div>

  <div class="wrap" id="authWrap">
    <div class="card">
      <div class="logoWrap"><div class="logo">DNK</div></div>
      <div class="cap">DNK | OMEGA 3.1</div>
      <div class="sub">–°–µ–∫—Ä–µ—Ç–Ω—ã–π —à–ª—é–∑</div>

      <div class="pad" id="pad"></div>

      <div class="row">ID: <span class="chip" id="frontId">----</span><button class="copy" id="copyBtn">‚ßâ</button></div>
      <div class="hint" id="turnHint"><b>TURN:</b> –≥–æ—Ç–æ–≤–æ</div>
      <div class="hint" id="peerHint"><b>–£–ó–ï–õ:</b> –æ–∂–∏–¥–∞–Ω–∏–µ</div>
    </div>
  </div>

  <div id="app">
    <div id="video-zone">
      <video id="remote-v" autoplay playsinline></video>
      <video id="local-v" autoplay playsinline muted></video>
      <div id="wait"><div class="spin"></div><div class="stxt" style="letter-spacing:.3em; color:#fff;">–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø...</div></div>
    </div>

    <div id="footer">
      <div class="panel" id="setup">
        <div class="row2" style="justify-content:space-between; margin-bottom:12px;">
          <div class="stxt" style="letter-spacing:.2em;">–ú–û–ô ID: <b style="color:var(--p); font-size:12px;" id="myIdTxt">----</b></div>
          <button class="tiny" onclick="location.reload()">‚Üª</button>
        </div>
        <div class="row2">
          <input class="in" id="target" placeholder="ID –¶–ï–õ–ò" maxlength="4" />
          <button class="cta" id="connect">–°–í–Ø–ó–¨</button>
        </div>
      </div>

      <div id="controls">
        <button class="circle-btn btn-blue" id="video">üìπ</button>
        <button class="circle-btn btn-green" id="hang" style="display:none;">‚èπ</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const setStatus = (t, c) => { $("status").textContent = t; $("dot").style.background = c || "#94a3b8"; };

  const ICE_SERVERS = [
    { urls: "stun:stun.relay.metered.ca:80" },
    {
      urls: [
        "turn:standard.relay.metered.ca:80",
        "turn:standard.relay.metered.ca:80?transport=tcp",
        "turn:standard.relay.metered.ca:443",
        "turns:standard.relay.metered.ca:443?transport=tcp"
      ],
      username: "0d0bf8d106dd90657dca0a1d",
      credential: "2D4ts2w87TtkX1xU"
    }
  ];

  let myId = localStorage.getItem("myGalaxyId");
  if (!myId) {
    myId = Math.random().toString(36).slice(2,6).toUpperCase();
    localStorage.setItem("myGalaxyId", myId);
  }
  $("frontId").textContent = myId;
  $("myIdTxt").textContent = myId;

  async function copyText(text){
    try { await navigator.clipboard.writeText(text); return true; }
    catch {
      try{
        const ta = document.createElement("textarea");
        ta.value = text; ta.style.position="fixed"; ta.style.opacity="0";
        document.body.appendChild(ta); ta.select();
        const ok = document.execCommand("copy");
        document.body.removeChild(ta);
        return ok;
      } catch { return false; }
    }
  }

  $("copyBtn").onclick = async () => {
    if (await copyText(myId)) { setStatus("–°–ö–û–ü–ò–†–û–í–ê–ù–û", "#22c55e"); setTimeout(()=>setStatus("–û–ñ–ò–î–ê–ù–ò–ï","#94a3b8"), 900); }
    else setStatus("–ö–û–ü–ò–†–£–ô –†–£–ö–ê–ú–ò", "#f59e0b");
  };

  const keys = [
    {i:'–ö–ò–ï–í',v:'kyiv'},{i:'–†–ò–ú',v:'rome'},
    {i:'–ü–ê–†–ò–ñ',v:'paris'},{i:'–¢–û–ö–ò–û',v:'tokyo'},
    {i:'–ë–ï–†–õ–ò–ù',v:'berlin'},{i:'–û–°–õ–û',v:'oslo'},
    {i:'–°–ï–£–õ',v:'seoul'},{i:'–í–ï–ù–ê',v:'vienna'},
    {i:'–ë–ê–ö–£',v:'baku'},{i:'–î–û–•–ê',v:'doha'}
  ];

  let roomPass = "", peer = null, conn = null, localStream = null, pingTimer = null;

  function enterApp(){
    $("authWrap").style.display = "none";
    $("app").style.display = "block";
  }

  function showHints(turnText, turnColor, peerText, peerColor){
    $("turnHint").innerHTML = "<b>TURN:</b> " + turnText;
    $("turnHint").style.color = turnColor || "#64748b";
    $("peerHint").innerHTML = "<b>–£–ó–ï–õ:</b> " + peerText;
    $("peerHint").style.color = peerColor || "#64748b";
  }

  async function initPeer(){
    if (!window.Peer){
      showHints("–Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω (CDN –±–ª–æ–∫?)", "#ef4444", "–æ—à–∏–±–∫–∞", "#ef4444");
      setStatus("–û–®–ò–ë–ö–ê", "#ef4444");
      return;
    }

    showHints("–≥–æ—Ç–æ–≤ (relay-only)", "#22c55e", "–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ‚Ä¶", "#0ea5e9");
    setStatus("–£–ó–ï–õ‚Ä¶", "#0ea5e9");

    try{ peer && peer.destroy && peer.destroy(); } catch(_){}

    peer = new Peer(roomPass + "-" + myId.toLowerCase(), {
      config: {
        iceServers: ICE_SERVERS,
        iceTransportPolicy: "all" // <<< –†–∞–∑—Ä–µ—à–∞–µ–º –ø—Ä—è–º—É—é —Å–≤—è–∑—å, –∞ —Å–µ—Ä–≤–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –∫–∞–∫ –∑–∞–ø–∞—Å–∫—É!
      },
      debug: 0
    });

    peer.on("open", () => {
      setStatus("–í –°–ï–¢–ò", "#22c55e");
      showHints("relay-only ‚úÖ", "#22c55e", "–≥–æ—Ç–æ–≤ ‚úÖ", "#22c55e");
    });
    
    // –ê–≤—Ç–æ-—Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç –µ—Å–ª–∏ —Å–∏–≥–Ω–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä —Ä–µ—à–∏—Ç —É—Å–Ω—É—Ç—å
    peer.on("disconnected", () => {
      if (!peer.destroyed) {
        console.log("–†–µ–∫–æ–Ω–Ω–µ–∫—Ç –∫ —Å–µ—Ç–∏...");
        peer.reconnect();
      }
    });

    peer.on("error", (e) => {
      console.error(e);
      setStatus("–°–ë–û–ô –£–ó–õ–ê", "#ef4444");
      showHints("relay-only ‚ö†Ô∏è", "#f59e0b", "–æ—à–∏–±–∫–∞ ‚ùå", "#ef4444");
    });

    peer.on("connection", (c) => { conn = c; bindConn(); });

    peer.on("call", async (call) => {
      try{
        localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
        $("local-v").srcObject = localStream;
        $("local-v").style.display = "block";
        call.answer(localStream);

        call.on("stream", (s) => {
          $("remote-v").srcObject = s;
          $("remote-v").style.display = "block";
          $("wait").style.display = "none";

          $("setup").style.display = "none";
          $("controls").style.display = "flex";
          $("video").style.display = "none";
          $("hang").style.display = "block";

          setStatus("–ù–ê –°–í–Ø–ó–ò", "#22c55e");
        });

        call.on("close", closeCallUI);
      } catch(_) {
        setStatus("–î–û–°–¢–£–ü?", "#f59e0b");
      }
    });
  }

  function bindConn(){
    if (!conn) return;
    conn.on("open", () => {
      $("setup").style.display = "none";
      $("controls").style.display = "flex";
      setStatus("–ö–ê–ù–ê–õ –û–¢–ö–†–´–¢", "#0ea5e9");
      
      // –°–ï–ö–†–ï–¢–ù–´–ô –ü–£–õ–¨–°: –Ω–µ –¥–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞–º –æ—Ç—Ä—É–±–∏—Ç—å —Å–≤—è–∑—å —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
      clearInterval(pingTimer);
      pingTimer = setInterval(() => {
        if (conn && conn.open) conn.send("pulse");
      }, 3000);
    });
    
    conn.on("data", (d) => { /* –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø—É–ª—å—Å, –æ–Ω –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è —É–¥–µ—Ä–∂–∞–Ω–∏—è –∫–∞–Ω–∞–ª–∞ */ });
    
    conn.on("close", () => {
      clearInterval(pingTimer);
      setStatus("–û–ë–†–´–í", "#ef4444");
      $("setup").style.display = "block";
      $("controls").style.display = "none";
    });
  }

  function closeCallUI(){
    try{ $("remote-v").srcObject = null; }catch(_){}
    $("remote-v").style.display = "none";
    $("local-v").style.display = "none";
    $("wait").style.display = "flex";

    setStatus("–ö–ê–ù–ê–õ –û–¢–ö–†–´–¢", "#0ea5e9");
    $("video").style.display = "block";
    $("hang").style.display = "none";
  }

  $("pad").innerHTML = "";
  keys.forEach(k => {
    const b = document.createElement("button");
    b.className = "btn";
    b.textContent = k.i;
    b.onclick = async () => { roomPass = k.v; enterApp(); await initPeer(); };
    $("pad").appendChild(b);
  });

  $("connect").onclick = () => {
    const tid = ($("target").value || "").trim().toUpperCase();
    if (!tid || !peer) return;
    setStatus("–ü–û–ò–°–ö‚Ä¶", "#0ea5e9");
    localStorage.setItem("lastTarget", tid);
    conn = peer.connect(roomPass + "-" + tid.toLowerCase());
    bindConn();
  };
  const last = localStorage.getItem("lastTarget");
  if (last) $("target").value = last;

  $("video").onclick = async () => {
    if (!conn || !conn.open) return;
    try{
      localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
      $("local-v").srcObject = localStream;
      $("local-v").style.display = "block";

      const call = peer.call(conn.peer, localStream);
      $("video").style.display = "none";
      $("hang").style.display = "block";

      call.on("stream", (s) => {
        $("remote-v").srcObject = s;
        $("remote-v").style.display = "block";
        $("wait").style.display = "none";
        setStatus("–ù–ê –°–í–Ø–ó–ò", "#22c55e");
      });
      call.on("close", closeCallUI);
    } catch(e){
      console.error(e);
      setStatus("–û–®–ò–ë–ö–ê –ö–ê–ú–ï–†–´", "#f59e0b");
    }
  };

    // === –§–£–ù–ö–¶–ò–Ø –Ø–î–ï–†–ù–û–ô –ó–ê–ß–ò–°–¢–ö–ò –í–°–ï–• –°–ï–ê–ù–°–û–í ===
  function killAll() {
    setStatus("–û–¢–ö–õ–Æ–ß–ï–ù–ò–ï...", "#f59e0b");
    
    // 1. –í—ã–¥–∏—Ä–∞–µ–º —à–Ω—É—Ä –∏–∑ –∫–∞–º–µ—Ä—ã –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
    if (localStream) {
      localStream.getTracks().forEach(t => t.stop());
      localStream = null;
    }
    
    // 2. –ì–ª—É—à–∏–º –Ω–∞—à —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –ø—É–ª—å—Å
    if (typeof pingTimer !== 'undefined') clearInterval(pingTimer);
    
    // 3. –†–≤—ë–º –ø—Ä—è–º–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º
    if (conn) { conn.close(); conn = null; }
    
    // 4. –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å–∞–º —É–∑–µ–ª —Å–≤—è–∑–∏ (—á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä –ø—Ä–æ –Ω–∞—Å –∑–∞–±—ã–ª)
    if (peer) { peer.destroy(); peer = null; }
    
    // 5. –î–∞–µ–º –ø–æ–ª—Å–µ–∫—É–Ω–¥—ã –Ω–∞ –æ—Å—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–æ–¥–æ–≤ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    setTimeout(() => location.reload(), 500);
  }

  // –í–µ—à–∞–µ–º –∑–∞—á–∏—Å—Ç–∫—É –Ω–∞ –∑–µ–ª–µ–Ω—É—é –∫–Ω–æ–ø–∫—É (–∑–∞–≤–µ—Ä—à–∏—Ç—å –≤—ã–∑–æ–≤)
  $("hang").onclick = killAll;

  // –ò –∑–∞–æ–¥–Ω–æ –ø–æ–≤–µ—Å–∏–º –µ—ë –Ω–∞ –º–∞–ª–µ–Ω—å–∫—É—é –∫–Ω–æ–ø–∫—É ‚Üª –≤–æ–∑–ª–µ —Ç–≤–æ–µ–≥–æ ID (—Ä—É—á–Ω–æ–π —Å–±—Ä–æ—Å)
  document.querySelector('.tiny').onclick = killAll;

  showHints("–≥–æ—Ç–æ–≤ (metered)", "#22c55e", "–æ–∂–∏–¥–∞–Ω–∏–µ", "#64748b");
})();
</script>
</body>
</html>
